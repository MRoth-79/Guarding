<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×× ×ª×— ×˜×‘×œ×ª ××©××¨×•×ª ×©×‘×•×¢×™×ª ğŸ“…</title>
    <style>
        /* ** ×¢×™×¦×•×‘ ×’×œ×•×‘×œ×™ ×•××•×“×¨× ×™ ** */
        :root {
            /* ×’×•×•× ×™× ×›×—×•×œ×™× ×¨×›×™× ×œ×˜×‘×œ×” */
            --primary-blue: #4f8ab4; /* ×›×—×•×œ ×¨××©×™ ×—×“×© */
            --secondary-blue: #78a9c2; /* ×›×—×•×œ ××©× ×™ ×—×“×© */
            --light-blue-bg: #eaf3f8; /* ×¨×§×¢ ×‘×”×™×¨ */
            --accent-red: #e57373; /* ××“×•× ×œ×”×“×’×©×” (×œ×™×•×•×™) */
            /* ×¦×‘×¢×™ ×›×¤×ª×•×¨×™× ×•×“×’×©×™× */
            --btn-analyze: #26a69a; /* ×˜×•×¨×§×™×– */
            --btn-download: #607d8b; /* ××¤×•×¨-×›×—×•×œ */
            --btn-generate: #1e88e5; /* ×›×—×•×œ ×¢××•×§ */
            --btn-reset: #ef5350; /* ××“×•× ×‘×”×™×¨ */
            --btn-auto: #ffb300; /* ×¦×”×•×‘-×›×ª×•× ×œ×¡×™×“×•×¨ */
            --text-color: #333;
            --border-color: #cfd8dc;
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: right;
            direction: rtl;
            background-color: #f7f9fb;
            color: var(--text-color);
            padding: 20px;
            line-height: 1.6;
        }

        h2, h3 {
            color: var(--primary-blue);
            text-align: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* ** ×¢×™×¦×•×‘ ×›×¤×ª×•×¨×™× ×‘×•×œ×˜×™× ×•××¢×•×¦×‘×™× ** */
        button {
            border: none;
            padding: 12px 25px;
            margin: 5px;
            border-radius: 8px; /* ×¤×™× ×•×ª ××¢×•×’×œ×•×ª */
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
        }

        #analyzeButton { background-color: var(--btn-analyze); }
        #downloadButton { background-color: var(--btn-download); }
        #generateLinkButton { background-color: var(--btn-generate); }
        #resetButton { background-color: var(--btn-reset); }
        #autoScheduleButton { 
            background-color: var(--btn-auto); 
            width: 100%;
            margin-top: 20px;
            font-size: 18px;
            padding: 15px;
        }

        #button-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 15px;
        }

        /* ** ××–×•×¨ ×§×œ×˜ ** */
        #data-source-section {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            margin-top: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            box-sizing: border-box;
            resize: vertical;
        }

        .date-input-container {
            text-align: center;
            margin-bottom: 15px;
        }

        #startDate {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .file-format-info {
            text-align: center;
            color: #777;
            font-size: 0.9em;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f0f4f7;
            border-radius: 5px;
        }

        /* ** ×¢×™×¦×•×‘ ×˜×‘×œ×ª ×”××©××¨×•×ª (×›×—×•×œ×™×) ** */
        #schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: var(--shadow);
            border-radius: 10px;
            overflow: hidden;
            background-color: white;
        }

        #schedule-table th, #schedule-table td {
            border: 1px solid var(--border-color);
            padding: 12px 8px;
            text-align: center;
            min-width: 80px;
        }

        #schedule-table thead {
            background-color: var(--primary-blue);
            color: white;
            border-bottom: 3px solid var(--secondary-blue);
        }

        #schedule-table th {
            font-weight: 600;
            cursor: default;
        }

        #schedule-table tbody tr:nth-child(even) {
            background-color: var(--light-blue-bg);
        }

        /* ×©×•×¨×” ×¡×¤×¦×™×¤×™×ª: ×œ×™×•×•×™ 06:40 ×‘××“×•× ×‘×•×œ×˜ */
        .red-assistance-shift {
            background-color: #ffcdd2 !important; /* ×¨×§×¢ ××“×•× ×‘×”×™×¨ */
            color: #b71c1c; /* ×˜×§×¡×˜ ××“×•× ×›×”×” */
            font-weight: bold;
        }
        .red-assistance-shift td {
             /* ×’×‘×•×œ×•×ª ××“×•××™× */
            border: 1px solid var(--accent-red);
        }

        /* ×¡×’× ×•×Ÿ ×¢××•×“×ª ×”×©×¢×•×ª */
        .time-slot {
            background-color: var(--secondary-blue);
            color: white;
            font-weight: bold;
        }

        /* ** ×¢×™×¦×•×‘ ×©××•×ª ×”×¢×•×‘×“×™× (××•×“×¨× ×™ ×•××™× ×˜×¨××§×˜×™×‘×™) ** */
        .person {
            display: inline-block;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 500;
            background-color: #f0f0f0; /* ×‘×¨×™×¨×ª ××—×“×œ */
            color: #333; /* ×‘×¨×™×¨×ª ××—×“×œ */
            transition: transform 0.2s;
            cursor: help;
        }
        
        .person:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* ** ××¤×ª ×¦×‘×¢×™× ×“×™× ××™×ª ×œ×©××•×ª (×¢×œ ×¤×™ colorMap) ** */
        .color-×¡×ª×™×• { background-color: #81c784; color: #1b5e20; }
        .color-× ×ª×™ { background-color: #64b5f6; color: #0d47a1; }
        .color-×—×¡×•×Ÿ { background-color: #ffb74d; color: #e65100; }
        .color-×—×•×¨×—×” { background-color: #ba68c8; color: #4a148c; }
        .color-×¢×¨×Ÿ { background-color: #90a4ae; color: #263238; }
        .color-×œ×™×©×¢ { background-color: #ff8a65; color: #bf360c; }
        .color-×œ×™×× ×™ { background-color: #aed581; color: #33691e; }
        .color-× ××¨×•×“ { background-color: #4db6ac; color: #004d40; }
        .color-×××•×¨ { background-color: #f06292; color: #880e4f; }
        .color-××¡×£ { background-color: #fff176; color: #f57f17; }
        .color-×˜×’× ×™×” { background-color: #b39ddb; color: #311b92; }
        .color-×¢×™×“×Ÿ_×™× ×™×‘ { background-color: #80cbc4; color: #004d40; }
        .color-×’×•×œ×Ÿ { background-color: #e57373; color: #b71c1c; }
        .color-×©×œ×•××™ { background-color: #ffcc80; color: #e65100; }
        .color-×™×•×‘×™ { background-color: #9fa8da; color: #1a237e; }
        .color-×××™×¨ { background-color: #80deea; color: #006064; }
        .color-×—×‘×¨×•× ×™ { background-color: #d7ccc8; color: #3e2723; }
        .color-×—×’×™ { background-color: #c5e1a5; color: #33691e; }
        .color-×™×©×™ { background-color: #bbdefb; color: #0d47a1; }
        .color-× ×™×¨ { background-color: #f48fb1; color: #880e4f; }
        
        /* ** ×¢×™×¦×•×‘ ×ª××™ ××–×”×¨×” ** */
        .needs-selection, .daily-duplicate-warning {
            background-color: #ffebee; /* ××“×•× ×‘×”×™×¨ ×××•×“ */
            border: 2px dashed var(--accent-red);
        }
        .warning-text {
            display: block;
            font-size: 0.8em;
            color: var(--accent-red);
            margin-top: 5px;
            font-weight: 600;
        }

        .ok-shift { background-color: #e8f5e9; } /* ×™×¨×•×§ ×‘×”×™×¨ ×œ××©××¨×•×ª ×ª×§×™× ×•×ª */
        .night-shift-ok { background-color: #e3f2fd; } /* ×›×—×•×œ ×‘×”×™×¨ ×œ××©××¨×•×ª ×œ×™×œ×” */
        
        .date-text {
            display: block;
            font-size: 0.8em;
            font-weight: normal;
            opacity: 0.8;
            margin-top: 3px;
        }

        /* ** ×¢×™×¦×•×‘ ×˜×‘×œ×ª ×”×¡×™×›×•× (×§×˜× ×” ×•××•×“×¨× ×™×ª) ** */
        #summary-table {
            width: 50%; /* ×§×˜× ×” ×™×•×ª×¨ */
            margin: 20px auto;
            border-collapse: collapse;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        #summary-table th, #summary-table td {
            padding: 10px;
            border: 1px solid #eee;
        }

        #summary-table thead {
            background-color: #607d8b; /* ×›×—×•×œ-××¤×•×¨ ×›×”×” */
            color: white;
        }

        /* ×¡×’× ×•× ×•×ª ×©×•×¨×•×ª ×”×¡×™×›×•× */
        .low-shifts { background-color: #fbecec; color: #c62828; font-weight: bold; }
        .not-met-condition { background-color: #fff3e0; color: #ef6c00; font-weight: bold; }
        .shifts-3-count { background-color: #e8f5e9; color: #2e7d32; }
        .shifts-4-count { background-color: #c8e6c9; color: #1b5e20; font-weight: bold; }

        /* ×”×•×“×¢×ª ××¢×¨×›×ª */
        #link-message {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px 40px;
            background-color: #4CAF50;
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            font-size: 1.1em;
            text-align: center;
        }

        hr {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), var(--primary-blue), rgba(0, 0, 0, 0));
            margin: 30px 0;
        }

    </style>
</head>
<body onload="initializeData(); document.getElementById('analyzeButton').click();">

    <h2>×× ×ª×— ×˜×‘×œ×ª ××©××¨×•×ª ×©×‘×•×¢×™×ª ğŸ“…</h2>
    
    <div id="input-section-wrapper">
        
        <div id="data-source-section">
            <h3>× ×ª×•× ×™ ××©××¨×•×ª ×œ×¢×¨×™×›×” ×•××§×•×¨ ×”× ×ª×•× ×™× ğŸ“</h3>
            
            <div class="date-input-container">
                <label for="startDate">×ª××¨×™×š ×™×•× ×¨××©×•×Ÿ:</label>
                <input type="date" id="startDate" required>
            </div>
            
            <p class="file-format-info">
                ×”× ×ª×•× ×™× ×©×”×•×–× ×• ×›××Ÿ ×™×©××©×• ×œ× ×™×ª×•×—. **×”×¡×™×“×•×¨ ×”××•×˜×•××˜×™ ×™×ª×—×©×‘ ×¨×§ ×‘×¢×•×‘×“×™× ×©×¨×©××ª× ×›××•×¤×¦×™×” ×œ×›×œ ××©×‘×¦×ª!**
                <br>
                **×”×¢×¨×” ×—×©×•×‘×”:** ××©×‘×¦×ª '×œ×™×•×•×™ 06:40' ×××¤×©×¨×ª ×”×–× ×” ×™×“× ×™×ª ×‘×œ×‘×“ ×•××™× ×” × ×›×œ×œ×ª ×‘×¡×™×“×•×¨ ×”××•×˜×•××˜×™.
            </p>
            <textarea id="dataToAnalyze" 
                title="× ×ª×•× ×™ ××©××¨×•×ª ×œ×¢×¨×™×›×” ×•× ×™×ª×•×—"
                placeholder="×”×“×‘×§ ××ª × ×ª×•× ×™ ×”××©××¨×•×ª ×›××Ÿ (×¤×•×¨××˜: ×™×•×\n×©×¢×•×ª&#09;×¢×•×‘×“1&#09;×¢×•×‘×“2...)">
            </textarea>
            
            <div id="button-group">
                <button id="analyzeButton">× ×ª×— × ×ª×•× ×™× ğŸ”</button>
                <button id="downloadButton">×”×•×¨×“ ×§×•×‘×¥ CSV â¬‡ï¸</button>
                <button id="generateLinkButton">×”×•×¨×“ ×˜×‘×œ×ª HTML ××¢×•×¦×‘×ª ğŸ’¾</button> 
                <button id="resetButton">××¤×¡ × ×ª×•× ×™× ğŸ—‘ï¸</button>
            </div>
        </div>
        
    </div>
    
    <button id="autoScheduleButton">×¡×“×¨ ××•×˜×•××˜×™ ğŸ¤–</button>

    <div id="results-container">
        <p id="initial-message">×”×˜×¢×™× ×” ×”×¨××©×•× ×™×ª ×ª×¤×¢×™×œ ××ª ×”× ×™×ª×•×— ××•×˜×•××˜×™×ª.</p>
    </div>

    <div id="link-message">
        <p>âœ… ×§×•×‘×¥ HTML ×”×•×¨×“ ×‘×”×¦×œ×—×”!</p>
    </div>

    <script>
    // ... ×›×œ ×§×•×“ ×”-JavaScript ×××©×™×š ×›××Ÿ ...
        // ××©×ª× ×” ×’×œ×•×‘×œ×™ ×œ×©××™×¨×ª ×§×•×“ ×”-HTML ×©×œ ×”×˜×‘×œ×” ×”××¢×•×¦×‘×ª
        let lastRenderedTableHTML = '';

        // ** × ×ª×•× ×™ ××©××¨×•×ª ×œ×“×•×’×× (×”×©××¨×ª×™ ××ª ×”××©×ª× ×” ×”×’×œ×•×‘×œ×™ ×¨×™×§ ×›×“×™ ×©×”××©×ª××© ×™×–×™×Ÿ ××ª × ×ª×•× ×™×•) **
        const INITIAL_SCHEDULE_DATA = ``;  


        // ×”×’×“×¨×•×ª ×§×‘×•×¢×•×ª (×¢×•×“×›× ×• ×œ×›×œ×•×œ ××ª ×”××©×‘×¦×ª ×”×—×“×©×”)
        const MIN_REQUIRED = 2; // **×©×•× ×” ×-3 ×œ-2**
        const MAX_ALLOWED = 4;
        const EXPECTED_DAYS = ['×™×•× ×¨××©×•×Ÿ', '×™×•× ×©× ×™', '×™×•× ×©×œ×™×©×™', '×™×•× ×¨×‘×™×¢×™', '×™×•× ×—××™×©×™', '×™×•× ×©×™×©×™', '×™×•× ×©×‘×ª'];
        // **×©×™× ×•×™ ×›××Ÿ: ×”×•×¡×¤×ª ××©×‘×¦×ª ×”×©×¢×•×ª ×”×—×“×©×”**
        const EXPECTED_TIME_SLOTS = [
            '×œ×™×•×•×™ 06:40 (Assist)',
            '02:00 - 06:00 (Night)', 
            '06:00 - 10:00', 
            '10:00 - 14:00', 
            '14:00 - 18:00', 
            '18:00 - 22:00', 
            '22:00 - 02:00 (Night)'
        ];

        // ××¤×ª ×¦×‘×¢×™× (×¨×©×™××ª ×”×¢×•×‘×“×™× ×”×–××™× ×™× ×œ×¡×™×“×•×¨)
        const colorMap = {
            '×¡×ª×™×•': 'color-×¡×ª×™×•', '× ×ª×™': 'color-× ×ª×™', '×—×¡×•×Ÿ': 'color-×—×¡×•×Ÿ', '×—×•×¨×—×”': 'color-×—×•×¨×—×”',
            '×¢×¨×Ÿ': 'color-×¢×¨×Ÿ', '×œ×™×©×¢': 'color-×œ×™×©×¢', '×œ×™×× ×™': 'color-×œ×™×× ×™', '× ××¨×•×“': 'color-× ××¨×•×“',
            '×××•×¨': 'color-×××•×¨', '××¡×£': 'color-××¡×£', '×˜×’× ×™×”': 'color-×˜×’× ×™×”', '×¢×™×“×Ÿ ×™× ×™×‘': 'color-×¢×™×“×Ÿ_×™× ×™×‘',
            '×’×•×œ×Ÿ': 'color-×’×•×œ×Ÿ', '×©×œ×•××™': 'color-×©×œ×•××™', '×™×•×‘×™': 'color-×™×•×‘×™', '×××™×¨': 'color-×××™×¨',
            '×—×‘×¨×•× ×™': 'color-×—×‘×¨×•× ×™', '×—×’×™': 'color-×—×’×™', '×™×©×™': 'color-×™×©×™', '× ×™×¨': 'color-× ×™×¨'
        };

        /**
         * ×¤×•× ×§×¦×™×” ×œ××ª×—×•×œ ×”× ×ª×•× ×™× ×•×”×¦×‘×ª ×ª××¨×™×š ×™×•× ×¨××©×•×Ÿ (×”×™×•× ×”× ×•×›×—×™)
         */
        function initializeData() {
            document.getElementById('dataToAnalyze').value = INITIAL_SCHEDULE_DATA; 
            
            // ×”×’×“×¨×ª ×ª××¨×™×š ×”×™×•× ×›×‘×¨×™×¨×ª ××—×“×œ ×œ×ª××¨×™×š ×™×•× ×¨××©×•×Ÿ
            const today = new Date();
            let dayOfWeek = today.getDay(); // 0 = ×¨××©×•×Ÿ, 6 = ×©×‘×ª
            // ×× ×”×™×•× ×œ× ×¨××©×•×Ÿ, ×”×•×œ×›×™× ××—×•×¨×” ×œ×™×•× ×¨××©×•×Ÿ ×©×œ ×”×©×‘×•×¢ ×”× ×•×›×—×™
            if (dayOfWeek !== 0) {
                today.setDate(today.getDate() - dayOfWeek); 
            }
            
            // ×¤×•×¨××˜ YYYY-MM-DD
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = formattedDate;
        }

        /**
         * ×¤×•× ×§×¦×™×” ×©××§×‘×œ×ª ×ª××¨×™×š ×”×ª×—×œ×” ×•××—×–×™×¨×” ××¢×¨×š ×ª××¨×™×›×™× ×œ×©×‘×•×¢.
         * @param {string} startDateString - ×ª××¨×™×š ×‘×¤×•×¨××˜ YYYY-MM-DD (×™×•× ×¨××©×•×Ÿ)
         * @returns {Array<string>} - ××¢×¨×š ×©×œ 7 ×ª××¨×™×›×™× ×‘×¤×•×¨××˜ DD/MM
         */
        function getDatesForWeek(startDateString) {
            const dates = [];
            // ×ª×™×§×•×Ÿ: ×™×¦×™×¨×ª ××•×‘×™×™×§×˜ Date ×¢× ×§×™×–×•×– ××–×•×¨ ×–××Ÿ ×›×“×™ ×œ×× ×•×¢ ×˜×¢×•×ª ×©×œ ×™×•× ×§×•×“×
            const [year, month, day] = startDateString.split('-');
            const startDate = new Date(year, month - 1, day);
            
            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dayStr = String(currentDate.getDate()).padStart(2, '0');
                const monthStr = String(currentDate.getMonth() + 1).padStart(2, '0');
                
                dates.push(`${dayStr}/${monthStr}`);
            }
            return dates;
        }

        /**
         * ×¤×•× ×§×¦×™×” ×œ× ×™×§×•×™ ××’×¨×¡×™×‘×™ ×©×œ ×©×•×¨×” ××ª×•×•×™× ×‘×œ×ª×™ × ×¨××™× ×•×¨×™×•×•×— (× ×©××¨×ª ×–×”×”)
         */
        function aggressiveClean(line) {
            return line.replace(/[\u0000-\u001F\u007F-\u009F\uFEFF\u00A0]/g, '').trim();
        }
        
        /**
         * ×¤×•× ×§×¦×™×” ×œ×¢×™×‘×•×“ ×˜×§×¡×˜ ×¢× ×—×œ×•×§×” ×× ×›×™×ª ×œ×¤×™ ×™××™× (× ×©××¨×ª ×–×”×”)
         */
        function parseVerticalText(text) {
            const lines = text.split(/\r?\n|\r/);  
            const rawDayData = {};
            let currentDay = null;
            
            // ×™×¦×™×¨×ª ××¤×ª ×‘×“×™×§×” ×¢×‘×•×¨ ×¡×œ×•×˜×™× ×©×œ ×©×¢×•×ª
            const timeSlotCheckMap = {};
            EXPECTED_TIME_SLOTS.forEach(slot => {
                // ×œ×•×§×—×™× ×¨×§ ××ª ×”×—×œ×§ ×©×œ ×”×©×¢×•×ª
                const timePart = slot.split('(')[0].trim();
                timeSlotCheckMap[timePart] = slot;
            });
            

            lines.forEach(line => {
                const cleanedLine = aggressiveClean(line);
                
                if (cleanedLine.length === 0) {
                    return;
                }

                const dayMatch = EXPECTED_DAYS.find(day => cleanedLine === day || cleanedLine.startsWith(day));

                if (dayMatch) {
                    currentDay = dayMatch;
                    rawDayData[currentDay] = [];
                } else if (currentDay) {
                    // ×—×œ×•×§×” ×œ×¤×™ ×˜××‘×™× ××• ×¨×•×•×—×™× ××¨×•×‘×™×
                    const parts = line.split(/\s{2,}|\t/).map(p => p.trim());  
                    const timeSlotString = parts[0];
                    
                    // ×‘×“×™×§×” ×”×× ×”×—×œ×§ ×”×¨××©×•×Ÿ ×”×•× ××©×‘×¦×ª ×©×¢×•×ª ××•×›×¨×ª
                    const isTimeSlot = Object.keys(timeSlotCheckMap).some(timePart => timeSlotString && timeSlotString.startsWith(timePart));
                    // ×‘×“×™×§×” ××™×•×—×“×ª ×œ'×œ×™×•×•×™ 06:40'
                    const isAssistanceSlot = timeSlotString === '×œ×™×•×•×™ 06:40';

                    if (parts.length > 0 && (isTimeSlot || isAssistanceSlot)) {
                        const potentialNames = parts.slice(1);
                        const names = potentialNames.filter(name => name.length > 0).map(name => name.trim());
                        rawDayData[currentDay].push(names.join(','));
                    }
                }
            });

            const daysFound = Object.keys(rawDayData);
            
            if (daysFound.length === 0) {
                return { error: '×œ× × ××¦××• × ×ª×•× ×™× ×ª×§×™× ×™× ××• ×©×œ× ×–×•×”×• ×™××™× ×‘×¤×•×¨××˜ × ×›×•×Ÿ. ×•×“× ×©×”× ×ª×•× ×™× ××ª×—×™×œ×™× ×‘"×™×•× ×¨××©×•×Ÿ".' };
            }

            const scheduleTable = [];  
            for (let i = 0; i < EXPECTED_TIME_SLOTS.length; i++) {
                const row = [];
                for (let j = 0; j < EXPECTED_DAYS.length; j++) {
                    const day = EXPECTED_DAYS[j];
                    const dayShifts = rawDayData[day];
                    
                    if (!dayShifts || dayShifts.length !== EXPECTED_TIME_SLOTS.length) {
                        return { error: `×©×’×™××” ×‘×™×•× **${day}**: × ××¦××• ×¨×§ ${dayShifts?.length || 0} ××©××¨×•×ª ×‘××§×•× ${EXPECTED_TIME_SLOTS.length} ××©××¨×•×ª. ×™×© ×œ×ª×§×Ÿ ××ª ×›××•×ª ×”×©×•×¨×•×ª ×‘×™×•× ×–×”.` };
                    }
                    row.push(dayShifts[i]);
                }
                scheduleTable.push(row);
            }

            return { days: EXPECTED_DAYS, data: scheduleTable };
        }

        /**
         * ×¤×•× ×§×¦×™×” ×œ×‘× ×™×™×ª ×”×˜×‘×œ×” ×•×‘×™×¦×•×¢ ×”× ×™×ª×•×— - ×›×•×œ×œ ×”×¦×’×ª ×ª××¨×™×›×™×
         */
        function renderSchedule(parsedData) {
            const resultsContainer = document.getElementById('results-container');
            const startDateString = document.getElementById('startDate').value;

            if (parsedData.error) {
                resultsContainer.innerHTML = `<p class="warning-text">âŒ ×©×’×™××ª × ×ª×•× ×™×: ${parsedData.error}</p>`;
                return;
            }
            
            if (!startDateString) {
                 resultsContainer.innerHTML = `<p class="warning-text">âŒ ×× × ×‘×—×¨ ×ª××¨×™×š ×”×ª×—×œ×” (×™×•× ×¨××©×•×Ÿ) ×œ×¤× ×™ ×”× ×™×ª×•×—.</p>`;
                return;
            }

            const datesForWeek = getDatesForWeek(startDateString);
            const { days: dayHeaders, data: scheduleData } = parsedData;

            // **1. ×™×¦×™×¨×ª HTML ×¢×‘×•×¨ ×”×˜×‘×œ×” ×”×× ×•×ª×—×ª**
            let tableHTML = '<h3>×˜×‘×œ×ª ××©××¨×•×ª ×× ×•×ª×—×ª</h3>';
            
            tableHTML += '<p class="file-format-info" style="text-align: center; color: var(--primary-blue);">**×”×’×“×¨×•×ª:** ××©××¨×ª ×™×•× (06:00-22:00): 1 ×¢×•×‘×“. ××©××¨×ª ×œ×™×œ×” (02:00-06:00, 22:00-02:00): ×¢×“ 2 ×¢×•×‘×“×™×.</p>';

            // ×™×¦×™×¨×ª ×˜×‘×œ×ª ×”× ×ª×•× ×™× ×”×¨××©×™×ª
            let scheduleTableHTML = '<table id="schedule-table"><thead><tr><th>×©×¢×•×ª / ×™×•×</th>';
            
            // ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×”×™××™× ×›×•×œ×œ ×”×ª××¨×™×›×™×
            dayHeaders.forEach((day, index) => { 
                scheduleTableHTML += `<th>${day}<span class="date-text">${datesForWeek[index]}</span></th>`; 
            });
            scheduleTableHTML += '</tr></thead><tbody>';

            
            const allShifts = {};
            const dailyCheck = {};
            
            scheduleData.forEach((row, rowIndex) => {
                const timeSlotFull = EXPECTED_TIME_SLOTS[rowIndex];
                // **×©×™× ×•×™ ×›××Ÿ: ×”×’×“×¨×ª ×¡×•×’ ×”××©××¨×ª**
                const isNightShift = timeSlotFull.includes('(Night)');
                const isAssistanceShift = timeSlotFull.includes('(Assist)');  
                const timeSlotDisplay = timeSlotFull.replace(' (Night)', '').replace(' (Assist)', '');
                
                // ×œ×™×•×•×™ 06:40 ××•×’×“×¨ ×›××©××¨×ª ×™×•× (××§×¡×™××•× 1), ×œ×™×œ×” ××§×¡×™××•× 2, ×”×©××¨ ××§×¡×™××•× 1.
                const maxAllowedInShift = isNightShift ? 2 : 1; 
                
                // **×©×™× ×•×™ ×›××Ÿ: ×”×•×¡×¤×ª ××—×œ×§×ª CSS ×œ×©×•×¨×” ×”×—×“×©×”**
                const rowClass = isAssistanceShift ? 'red-assistance-shift' : '';
                
                scheduleTableHTML += `<tr class="${rowClass}"><td class="time-slot">${timeSlotDisplay}</td>`;

                row.forEach((cellContent, colIndex) => {
                    const day = dayHeaders[colIndex];
                    const names = cellContent.split(',').filter(name => name);
                    const numNames = names.length;
                    
                    if (!dailyCheck[day]) { dailyCheck[day] = new Set(); }
                    
                    let dailyDuplicateFound = false;
                    names.forEach(name => {
                        const cleanedName = name.trim();
                        // 1. ×‘×“×™×§×ª ×›×¤×™×œ×•×ª ×™×•××™×ª (×œ× ×›×•×œ×œ ×œ×™×•×•×™ 06:40)
                        if (!isAssistanceShift && dailyCheck[day].has(cleanedName)) {
                            dailyDuplicateFound = true;
                        }
                        dailyCheck[day].add(cleanedName);
                        
                        // 2. ××™×¡×•×£ ×›×œ×œ×™ ×œ×ª×“×™×¨×•×ª ×©×‘×•×¢×™×ª
                        allShifts[cleanedName] = (allShifts[cleanedName] || 0) + 1;
                    });
                    
                    // ×¢×™×¦×•×‘ ×”×ª×
                    let cellClass = '';
                    let warningText = '';

                    if (numNames === 0) {
                        // ×× ×–×• ××©××¨×ª ×œ×™×•×•×™, ×¨×™×§ ×–×” ××•×¤×¦×™×•× ×œ×™, ××—×¨×ª ×“×•×¨×© ×‘×—×™×¨×”
                        if (isAssistanceShift) {
                            cellClass = ''; // ××™×Ÿ ×¦×•×¨×š ×‘-needs-selection ×›×™ ×œ× ×—×™×™×‘ ×œ×”×™×•×ª ×©× ××™×©×”×•
                            warningText = '<span class="warning-text" style="color:#00838f;">××©×‘×¦×ª ×œ×™×•×•×™ ×™×“× ×™×ª</span>';
                        } else {
                            cellClass = 'needs-selection';
                            warningText = '<span class="warning-text">×‘×¢×™×”! ××©×‘×¦×ª ×¨×™×§×”</span>';
                        }
                    } else if (dailyDuplicateFound) {
                        cellClass = 'daily-duplicate-warning';
                        warningText = '<span class="warning-text">âš ï¸ ×›×¤×™×œ×•×ª ×™×•××™×ª!</span>';
                    } else if (numNames > maxAllowedInShift && numNames > 0) {
                            // ×× ×™×© ×™×•×ª×¨ ×¢×•×‘×“×™× ×××” ×©× ×“×¨×©, ×× ×—× ×• ××¦×™×’×™× ××–×”×¨×”
                           cellClass = 'needs-selection';  
                           warningText = `<span class="warning-text">âš ï¸ ×™×•×ª×¨ ××“×™ ×¢×•×‘×“×™× (${numNames}). ×“×¨×•×©×™×: ${maxAllowedInShift}</span>`;
                    } else {
                        // **×©×™× ×•×™ ×›××Ÿ: ×§×‘×™×¢×ª ×§×œ××¡ ×œ×¤×™ ×¡×•×’ ×”××©××¨×ª**
                        if (isAssistanceShift) {
                            cellClass = 'red-assistance-shift';
                        } else {
                            cellClass = isNightShift ? 'night-shift-ok' : 'ok-shift';
                        }
                    }

                    const formattedNames = names.map(name => {
                        const key = name.includes(' ') ? name.trim().replace(' ', '_') : name.trim();
                        const className = colorMap[key] || 'person';
                        return `<span class="person ${className}" title="${name} - ${day}, ${timeSlotDisplay}">${name}</span>`;
                    }).join('');

                    scheduleTableHTML += `<td data-day="${day}" data-time="${timeSlotDisplay}" class="${cellClass}">
                        ${formattedNames} ${warningText}
                    </td>`;
                });
                scheduleTableHTML += '</tr>';
            });
            scheduleTableHTML += '</tbody></table>';
            
            // **2. ×©××™×¨×ª ×”-HTML ×©×œ ×”×˜×‘×œ×” ×œ××©×ª× ×” ×’×œ×•×‘×œ×™**
            lastRenderedTableHTML = scheduleTableHTML; 
            
            // **3. ×”××©×š ×™×¦×™×¨×ª ×˜×‘×œ×ª ×”×¡×™×›×•× ×•×”×¦×’×”**
            tableHTML += scheduleTableHTML + '<hr>';
            
//////////////////////////////////////////////////////////////////////////////////////////////
            
            // ×™×¦×™×¨×ª ×˜×‘×œ×ª ×”×¡×™×›×•×
            let summaryTableHTML = `<h3>×¡×™×›×•× ×ª×“×™×¨×•×ª ×”×•×¤×¢×” ×©×œ ×›×œ ×¢×•×‘×“ (××™× ×™××•×: ${MIN_REQUIRED}, ××§×¡×™××•×: ${MAX_ALLOWED})</h3>`; // **×¢×•×“×›×Ÿ ×”×›×™×ª×•×‘**
            summaryTableHTML += `
                <table id="summary-table">
                    <thead>
                        <tr>
                            <th>××¡'</th>
                            <th>×©× ×”×¢×•×‘×“</th>
                            <th>×¡×š ×”×•×¤×¢×•×ª</th>
                            <th>×¢××™×“×” ×‘×ª× ××™ (${MIN_REQUIRED}-${MAX_ALLOWED})</th>
                        </tr>
                    </thead>
                    <tbody id="summary-body">`;
            
            const sortedNames = Object.keys(allShifts).sort();
            let counter = 1;
            sortedNames.forEach(name => {
                const count = allShifts[name];
                
                let rowClass = '';
                let statusText = '';

                // **×©×™× ×•×™ ×›××Ÿ: ×‘×“×™×§×ª ×”×˜×•×•×— ×”×—×“×© (2-4)**
                if (count >= MIN_REQUIRED && count <= MAX_ALLOWED) {
                    rowClass = (count === MAX_ALLOWED) ? 'shifts-4-count' : 'shifts-3-count'; 
                    statusText = `âœ… ×¢××“ (${count} ××©××¨×•×ª)`;
                } else if (count < MIN_REQUIRED) {
                    rowClass = 'low-shifts';
                    statusText = `âŒ ×œ× ×¢××“ (××¢×˜ ××“×™ - ${count})`;
                } else if (count > MAX_ALLOWED) {
                    rowClass = 'not-met-condition';
                    statusText = `âŒ ×œ× ×¢××“ (×™×•×ª×¨ ××“×™ - ${count})`;
                } else {
                    rowClass = 'not-met-condition'; 
                    statusText = `âŒ ×œ× ×¢××“ (${count})`;
                }
                
                summaryTableHTML += `
                    <tr class="${rowClass}">
                        <td style="text-align: center;">${counter++}</td>
                        <td>${name}</td>
                        <td style="text-align: center;">${count}</td>
                        <td style="text-align: center;">${statusText}</td>
                    </tr>
                `;
            });

            summaryTableHTML += '</tbody></table>';
            
            tableHTML += summaryTableHTML;

            resultsContainer.innerHTML = tableHTML;
        }


        /**
         * ×¤×•× ×§×¦×™×” ××¢×•×“×›× ×ª ×œ×”×•×¨×“×ª ×§×•×‘×¥ HTML ×©××›×™×œ ×¨×§ ××ª ×”×˜×‘×œ×” ×”××¢×•×¦×‘×ª - ×›×•×œ×œ ×ª××¨×™×›×™×
         */
        function downloadHtmlTable() {
            if (!lastRenderedTableHTML) {
                alert('××™×Ÿ ×˜×‘×œ×ª ××©××¨×•×ª ×× ×•×ª×—×ª! ×× × ×”×¤×¢×œ ××ª "×¡×“×¨ ××•×˜×•××˜×™ ğŸ¤–" ××• "× ×ª×— × ×ª×•× ×™× ğŸ”" ×ª×—×™×œ×”.');
                return;
            }
            
            const startDateString = document.getElementById('startDate').value;
            if (!startDateString) {
                alert('×× × ×‘×—×¨ ×ª××¨×™×š ×”×ª×—×œ×” (×™×•× ×¨××©×•×Ÿ) ×œ×¤× ×™ ×”×•×¨×“×ª ×”×§×•×‘×¥.');
                return;
            }

            const datesForWeek = getDatesForWeek(startDateString);
            
            // ×™×¦×™×¨×ª ×›×•×ª×¨×ª ×”×˜×‘×œ×” ××—×“×© ×›×“×™ ×œ×•×•×“× ×©×”×ª××¨×™×›×™× ××¢×•×“×›× ×™× ×‘×ª×•×š ×§×•×‘×¥ ×”-HTML ×œ×”×•×¨×“×”
            let updatedTableHTML = lastRenderedTableHTML;
            let headerReplacement = '<tr><th>×©×¢×•×ª / ×™×•×</th>';
            EXPECTED_DAYS.forEach((day, index) => {
                headerReplacement += `<th>${day}<span class="date-text">${datesForWeek[index]}</span></th>`;
            });
            headerReplacement += '</tr>';

            // ×”×—×œ×¤×ª ×”×›×•×ª×¨×ª ×”×™×©× ×” (×©××•×¨×” ×‘-lastRenderedTableHTML) ×‘×—×“×©×”
            // ×—×™×¤×•×© ×”-HTML ×©×œ ×›×•×ª×¨×ª ×”×˜×‘×œ×” ×‘-lastRenderedTableHTML
            const originalHeaderMatch = lastRenderedTableHTML.match(/<thead>(.*?)<\/thead>/s);
            if (originalHeaderMatch) {
                const originalHeaderContent = originalHeaderMatch[1];
                const newHeaderContent = originalHeaderContent.replace(/<tr>(.*?)<\/tr>/s, headerReplacement);
                updatedTableHTML = lastRenderedTableHTML.replace(originalHeaderMatch[0], `<thead>${newHeaderContent}</thead>`);
            }
            

            // ××•×¡×¤×™× ××ª ×›×œ ×”-CSS ×”×§×¨×™×˜×™ ××”×ª×’×™×ª <style>
            const style = document.querySelector('style').textContent;

            // ×™×•×¦×¨×™× ××ª ×§×•×‘×¥ ×”-HTML ×”× ×§×™ (××‘×•×“×“)
            const cleanHTMLContent = `
                <!DOCTYPE html>
                <html lang="he" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>×˜×‘×œ×ª ××©××¨×•×ª ×©×‘×•×¢×™×ª - ××¢×•×¦×‘×ª</title>
                    <style>
                        /* ×¡×’× ×•× ×•×ª ×‘×¡×™×¡×™×™× */
                        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; direction: rtl; background-color: #f7f9fb; color: #333; }
                        h2 { color: var(--primary-blue); padding-bottom: 15px; margin-bottom: 30px; }
                        
                        /* ××“×‘×™×§×™× ×›××Ÿ ××ª ×”-CSS ×”×¨×œ×•×•× ×˜×™ - ×›×•×œ×œ ×¡×’× ×•×Ÿ ×”×ª××¨×™×›×™× ×•×”×œ×™×•×•×™ */
                        ${style}
                        
                        /* ×”×¡×ª×¨×ª ×›×¤×ª×•×¨×™× ×•×¤×•× ×§×¦×™×•× ×œ×™×•×ª ×œ× ×¨×œ×•×•× ×˜×™×™× ×‘×“×£ ×”××•×¤×¨×“ */
                        #input-section-wrapper, #button-group, #autoScheduleButton, #resetButton { display: none !important; }
                        
                    </style>
                </head>
                <body>
                    <h2>×˜×‘×œ×ª ××©××¨×•×ª ×©×‘×•×¢×™×ª - ××©×•×‘×¦×ª ×•×¡×•×¤×™×ª (××¢×•×¦×‘×ª)</h2>
                    
                    <div id="results-container" style="max-width: 90%; margin: 20px auto;">
                        ${updatedTableHTML}
                    </div>
                    <p style="text-align: center; color: #777; margin-top: 30px;">
                        ×“×£ ×–×” × ×•×¦×¨ ××•×˜×•××˜×™×ª ×¢×œ ×™×“×™ ×× ×ª×— ×”××©××¨×•×ª.
                    </p>
                </body>
                </html>
            `;
            
            // ×™×¦×™×¨×ª Blob (×™×™×¦×•×’ ×§×•×‘×¥)
            const bom = '\ufeff';  
            const blob = new Blob([bom + cleanHTMLContent], { type: 'text/html;charset=utf-8' });
            
            // ×™×¦×™×¨×ª ×œ×™× ×§ ×–×× ×™ ×œ×”×•×¨×“×”
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');

            link.href = url;
            link.download = `schedule_table_${startDateString}_maor.html`;
            link.click();  

            // × ×™×§×•×™ ×”××©××‘×™× ×”×–×× ×™×™×
            URL.revokeObjectURL(url);
            
            // ×”×¦×’×ª ×”×•×“×¢×” ×§×¦×¨×” 
            const msg = document.getElementById('link-message');
            msg.querySelector('p').textContent = 'âœ… ×§×•×‘×¥ HTML ×”×•×¨×“ ×œ××—×©×‘×š!';
            msg.style.backgroundColor = '#4CAF50';
            msg.style.display = 'block';
            setTimeout(() => {
                msg.style.display = 'none';
                msg.style.backgroundColor = '#4CAF50';
            }, 3000);
        }

// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×¡×™×“×•×¨ ××•×˜×•××˜×™ ×©×œ ×”××©××¨×•×ª - ×¢× ××™×œ×•×¦×™×
function autoSchedule() {
    const textContent = document.getElementById('dataToAnalyze').value;
    const startDateString = document.getElementById('startDate').value;

    if (!startDateString) {
        alert('×× × ×‘×—×¨ ×ª××¨×™×š ×”×ª×—×œ×” (×™×•× ×¨××©×•×Ÿ) ×œ×¤× ×™ ×”×¡×™×“×•×¨ ×”××•×˜×•××˜×™.');
        return;
    }

    const initialParsedData = parseVerticalText(textContent);

    if (initialParsedData.error) {
        document.getElementById('results-container').innerHTML = `<p class="warning-text">âŒ ×©×’×™××” ×‘× ×™×ª×•×— × ×ª×•× ×™× ×§×™×™××™×. ×™×© ×œ×ª×§×Ÿ ××ª × ×ª×•× ×™ ×”×§×œ×˜ ×œ×¤× ×™ ×”×¡×™×“×•×¨ ×”××•×˜×•××˜×™.</p>`;
        return;
    }

    const allEmployees = Object.keys(colorMap).map(key => key.includes('_') ? key.replace('_', ' ') : key);
    const employeeShiftsCount = {}; // ×¡×¤×™×¨×ª ××©××¨×•×ª × ×•×›×—×™×ª ×œ×›×œ ×¢×•×‘×“
    allEmployees.forEach(name => employeeShiftsCount[name] = 0);

    // ×™×¦×™×¨×ª ××¢×¨×š ×—×“×© ×œ×ª×•×¦××•×ª (×©× × ×©××•×¨ ××ª ×”×¢×•×‘×“×™× ×”××©×•×‘×¦×™×)
    const newScheduleData = initialParsedData.data.map(row => row.map(cell => []));

    // **×©×œ×‘ 1: ×”×¢×ª×§×ª ×•×¢×“×›×•×Ÿ × ×ª×•× ×™× ×§×™×™××™× ×•××™×¡×•×£ × ×ª×•× ×™ ×–××™× ×•×ª**
    // ××¢×ª×™×§×™× ××ª × ×ª×•× ×™ ×”×œ×™×•×•×™ ×•××©×‘×¦×•×ª ×©×›×‘×¨ ××©×•×‘×¦×•×ª ×™×“× ×™×ª
    // ×•×‘×• ×–×× ×™×ª ×™×•×¦×¨×™× ××¤×ª ×–××™× ×•×ª ×œ××©×‘×¦×•×ª ×©×“×•×¨×©×•×ª ×¡×™×“×•×¨
    const availabilityMap = {}; // ×–××™× ×•×ª: { dayIndex: { shiftIndex: Set<Names> } }
    const dailyOccupancy = initialParsedData.days.map(() => new Set()); // ×¢×•×‘×“×™× ×©×›×‘×¨ ××©×•×‘×¦×™× ×‘×™×•× ××¡×•×™×

    initialParsedData.data.forEach((row, shiftIndex) => {
        const timeSlotFull = EXPECTED_TIME_SLOTS[shiftIndex];
        const isAssistanceShift = timeSlotFull.includes('(Assist)');
        const isNightShift = timeSlotFull.includes('(Night)');
        const maxAllowed = isNightShift ? 2 : 1;
        const required = isNightShift ? 2 : 1;
        
        row.forEach((cellContent, dayIndex) => {
            const day = initialParsedData.days[dayIndex];
            const availableNames = cellContent.split(',').map(name => name.trim()).filter(name => name.length > 0);
            
            // ×©×•××¨×™× ××ª ×”×–××™× ×•×ª ×œ×©×™××•×© ×‘×¡×™×“×•×¨ ×”××•×˜×•××˜×™, ×›×•×œ×œ ××œ×• ×©×¦×•×™× ×• ×›××©×•×‘×¦×™×
            if (!availabilityMap[dayIndex]) availabilityMap[dayIndex] = {};
            availabilityMap[dayIndex][shiftIndex] = new Set(availableNames);

            if (isAssistanceShift) {
                // ××©××¨×ª ×œ×™×•×•×™ - ×¨×§ ××¢×ª×™×§×™× ××ª ××” ×©×™×© ×•×¡×•×¤×¨×™× ××©××¨×•×ª
                const namesAssigned = cellContent.split(',').map(name => name.trim()).filter(name => name.length > 0);
                namesAssigned.forEach(name => {
                    newScheduleData[shiftIndex][dayIndex].push(name);
                    employeeShiftsCount[name] = (employeeShiftsCount[name] || 0) + 1;
                    dailyOccupancy[dayIndex].add(name); // ×¡×•×¤×¨×™× ×’× ×œ×™×•×•×™ ×›××©×‘×¦×ª ×™×•××™×ª
                });
            } else {
                // ×©××¨ ×”××©××¨×•×ª
                const existingAssignments = [];
                // ×× ×™×© ×›×‘×¨ ×¢×•×‘×“×™× ×©×•×‘×¦×• ×™×“× ×™×ª (×‘×œ×™ ×§×©×¨ ×œ×–××™× ×•×ª), ××©×‘×¦×™× ××•×ª× ×•××– ×¢×•×‘×¨×™× ×œ×¡×™×“×•×¨
                if (availableNames.length === required) {
                     availableNames.forEach(name => {
                        existingAssignments.push(name);
                    });
                }
                
                // ×”×¢×ª×§×” ×¨××©×•× ×™×ª: ×× ×™×© ×¤×—×•×ª ××”× ×“×¨×© ××• ×©×”×•×–× ×” ×–××™× ×•×ª ×‘×œ×‘×“, × ×©××™×¨ ×¨×™×§ ×•× ××©×™×š ×œ×©×œ×‘ 2
                if (existingAssignments.length === required) {
                    existingAssignments.forEach(name => {
                        newScheduleData[shiftIndex][dayIndex].push(name);
                        employeeShiftsCount[name] = (employeeShiftsCount[name] || 0) + 1;
                        dailyOccupancy[dayIndex].add(name);
                    });
                }
            }
        });
    });

    // **×©×œ×‘ 2: ×¡×™×“×•×¨ ××©××¨×•×ª ×—×¡×¨×•×ª (×©×œ× ×©×•×‘×¦×• ×™×“× ×™×ª ××• ×©×”×•×–× ×” ×‘×”×Ÿ ×¨×§ ×–××™× ×•×ª)**
    const shiftsToFill = [];
    initialParsedData.data.forEach((row, shiftIndex) => {
        const timeSlotFull = EXPECTED_TIME_SLOTS[shiftIndex];
        const isAssistanceShift = timeSlotFull.includes('(Assist)');
        if (isAssistanceShift) return; // ××ª×¢×œ××™× ×××©××¨×ª ×”×œ×™×•×•×™
        
        const isNightShift = timeSlotFull.includes('(Night)');
        const required = isNightShift ? 2 : 1;

        row.forEach((cellContent, dayIndex) => {
            if (newScheduleData[shiftIndex][dayIndex].length < required) {
                // ××©××¨×ª ×©×¦×¨×™×š ×œ××œ×
                shiftsToFill.push({ 
                    dayIndex, 
                    shiftIndex, 
                    requiredCount: required - newScheduleData[shiftIndex][dayIndex].length // ×›××” ×—×¡×¨×™×
                });
            }
        });
    });
    
    // ××™×•×Ÿ ×”××©××¨×•×ª ×œ××™×œ×•×™ ×œ×¤×™ ×›××•×ª ×”××¤×©×¨×•×™×•×ª ×”×–××™× ×•×ª (××¢×˜ ××¤×©×¨×•×™×•×ª ×§×•×“×)
    shiftsToFill.sort((a, b) => {
        const aCount = availabilityMap[a.dayIndex][a.shiftIndex].size;
        const bCount = availabilityMap[b.dayIndex][b.shiftIndex].size;
        return aCount - bCount;
    });


    // ×¤×•× ×§×¦×™×™×ª × ×™×§×•×“ ××•×¨×›×‘×ª
    function scoreEmployee(name, count, dayIndex) {
        let score = 0;
        
        // 1. ×¦×™×•×Ÿ ×œ×¤×™ ×ª×“×™×¨×•×ª ×›×•×œ×œ×ª: ×¢×“×™×¤×•×ª ×œ××™ ×©×©××¨ ×¤×—×•×ª
        score += (MAX_ALLOWED + 1) - count; 

        // 2. ×¢× ×™×©×” ×¢×œ ×›×¤×™×œ×•×ª ×™×•××™×ª
        if (dailyOccupancy[dayIndex].has(name)) {
            score -= 1000; // ×¢×•× ×© ×’×‘×•×” ×›×“×™ ×œ×× ×•×¢ ×›×¤×™×œ×•×ª
        }
        
        // 3. ×¢× ×™×©×” ×¢×œ ×—×¨×™×’×” ××”××§×¡×™××•× (4)
        if (count >= MAX_ALLOWED) {
             score -= 500; // ×¢×•× ×© ×’×‘×•×”
        }
        
        // 4. ×‘×•× ×•×¡ ×§×œ ×œ××™ ×©× ××¦× ×‘××™× ×™××•× (2) ××• ×§×¨×•×‘ ××œ×™×•
        if (count <= MIN_REQUIRED) {
             score += 10;
        }

        return score;
    }

    // ×œ×•×œ××ª ×¡×™×“×•×¨: ×¢×‘×•×¨ ×›×œ ××©××¨×ª ×©×—×¡×¨×”
    shiftsToFill.forEach(shift => {
        const { dayIndex, shiftIndex, requiredCount } = shift;
        const availableInSlot = Array.from(availabilityMap[dayIndex][shiftIndex]);
        const dayOccupied = dailyOccupancy[dayIndex];
        
        // ×¡×™× ×•×Ÿ: ××•×¦×™××™× ××ª ××™ ×©×›×‘×¨ ××©×•×‘×¥ ×‘××•×ª×• ×™×•×
        const filteredCandidates = availableInSlot.filter(name => !dayOccupied.has(name));

        // ×‘×—×™×¨×ª ×”×¢×•×‘×“×™× ×©×—×¡×¨×™×
        let needed = requiredCount;
        while (needed > 0) {
            
            if (filteredCandidates.length === 0) {
                // ×× ××™×Ÿ ××•×¢××“×™× ×–××™× ×™× ××•×˜×•××˜×™×ª, ×¢×•×‘×¨×™× ×”×œ××” (×ª×™×•×•×¦×¨ ×©×’×™××” ×©×œ ××©×‘×¦×ª ×¨×™×§×”/×—×œ×§×™×ª)
                break;
            }

            // ×—×™×©×•×‘ × ×™×§×•×“ ×œ×›×œ ××•×¢××“
            const scoredCandidates = filteredCandidates.map(name => {
                const currentCount = employeeShiftsCount[name] || 0;
                const score = scoreEmployee(name, currentCount, dayIndex);
                return { name, score, count: currentCount };
            });

            // ××™×™×Ÿ ×œ×¤×™ ×¦×™×•×Ÿ (×’×‘×•×” ×œ×¨××©×•×Ÿ)
            scoredCandidates.sort((a, b) => b.score - a.score);

            // ×‘×—×¨ ××ª ×”×¢×•×‘×“ ×‘×¢×œ ×”×¦×™×•×Ÿ ×”×’×‘×•×” ×‘×™×•×ª×¨, ×‘×ª× ××™ ×©×œ× ×—×¨×’ ××”××§×¡×™××•×
            const bestCandidate = scoredCandidates.find(c => c.count < MAX_ALLOWED);
            
            if (bestCandidate) {
                const name = bestCandidate.name;
                
                // ×©×™×‘×•×¥ ×”×¢×•×‘×“
                newScheduleData[shiftIndex][dayIndex].push(name);
                employeeShiftsCount[name]++;
                dailyOccupancy[dayIndex].add(name); // ×¡×™××•×Ÿ ×›××©×•×‘×¥ ×‘×™×•× ×–×”

                // ×”×¡×¨ ××ª ×”××•×¢××“ ××¨×©×™××ª ×”××•×¢××“×™× ×œ×©×™×‘×•×¥ ×‘××•×ª×” ××©×‘×¦×ª
                const indexToRemove = filteredCandidates.indexOf(name);
                if (indexToRemove > -1) {
                    filteredCandidates.splice(indexToRemove, 1);
                }
                
                needed--;
            } else {
                // ×× ×›×œ ×”××•×¢××“×™× ×”××¤×©×¨×™×™× ×›×‘×¨ ×”×’×™×¢×• ×œ××§×¡×™××•× ×”××•×ª×¨, ××¤×¡×™×§×™× ×œ× ×¡×•×ª ×œ××œ× ××ª ×”××©×‘×¦×ª ×”×–×•
                  break;
            }
        }
    });

    // **×©×œ×‘ 3: ×‘× ×™×™×ª ×˜×§×¡×˜ ×”×§×œ×˜ ××—×“×© ×•×”×¦×’×”**
    let newText = '';
    
    initialParsedData.days.forEach((day, dayIndex) => {
        newText += `${day}\n`;
        newScheduleData.forEach((row, shiftIndex) => {
            const timeSlotFull = EXPECTED_TIME_SLOTS[shiftIndex];
            const timeSlotDisplay = timeSlotFull.split('(')[0].trim(); // ×œ×•×§×—×™× ×¨×§ ××ª ×”×—×œ×§ ×©×œ ×”×©×¢×•×ª
            
            const namesAssigned = row[dayIndex];
            const namesString = namesAssigned.join('\t');
            
            newText += `${timeSlotDisplay}\t${namesString}\n`;
        });
        newText += '\n'; // ×”×¤×¨×“×” ×‘×™×Ÿ ×™××™×
    });

    // ×¢×“×›×•×Ÿ ×ª×™×‘×ª ×”×˜×§×¡×˜ ×¢× ×”× ×ª×•× ×™× ×”×—×“×©×™×
    document.getElementById('dataToAnalyze').value = newText.trim();
    
    // ×”×¤×¢×œ×ª ×”× ×™×ª×•×— ×œ×”×¦×’×ª ×”×˜×‘×œ×” ×•×”×¡×™×›×•× ×”××¢×•×“×›× ×™×
    const finalParsedData = parseVerticalText(newText.trim());
    renderSchedule(finalParsedData);

    // ×”×¦×’×ª ×”×•×“×¢×” ×¢×œ ×¡×™×•×
    const msg = document.getElementById('link-message');
    msg.querySelector('p').textContent = 'âœ… ×¡×™×“×•×¨ ××•×˜×•××˜×™ ×”×¡×ª×™×™×!';
    msg.style.backgroundColor = '#4fc3f7';
    msg.style.display = 'block';
    setTimeout(() => {
        msg.style.display = 'none';
        msg.style.backgroundColor = '#4CAF50';
    }, 3000);
}


        // ×§×™×©×•×¨ ××™×¨×•×¢×™× ×œ×›×¤×ª×•×¨×™×
        document.getElementById('analyzeButton').addEventListener('click', () => {
            const textContent = document.getElementById('dataToAnalyze').value;
            renderSchedule(parseVerticalText(textContent));
        });

        document.getElementById('resetButton').addEventListener('click', () => {
             document.getElementById('dataToAnalyze').value = '';
             document.getElementById('results-container').innerHTML = `<p id="initial-message">×”×˜×¢×™× ×” ×”×¨××©×•× ×™×ª ×ª×¤×¢×™×œ ××ª ×”× ×™×ª×•×— ××•×˜×•××˜×™×ª.</p>`;
             lastRenderedTableHTML = '';
             initializeData(); // ×›×“×™ ×œ×©×—×–×¨ ××ª ×ª××¨×™×š ×”×™×•× ×•× ×ª×•× ×™ ×‘×¨×™×¨×ª ×”××—×“×œ
        });
        
        document.getElementById('generateLinkButton').addEventListener('click', downloadHtmlTable);
        
        document.getElementById('autoScheduleButton').addEventListener('click', autoSchedule);


    </script>
</body>
</html>
