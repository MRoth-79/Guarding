<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×× ×ª×— ×˜×‘×œ×ª ××©××¨×•×ª ×©×‘×•×¢×™×ª ğŸ“…</title>
	<style>
		/* =========================================
		   1. ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ×•×”×’×“×¨×•×ª ×‘×¡×™×¡
		   ========================================= */
		:root {
			--primary-blue: #004D40; 
			--secondary-blue: #4DB6AC; 
			--light-bg-color: #F8FBFB; 
			--accent-red: #D32F2F; 
			--btn-analyze: #388E3C; 
			--btn-download: #546E7A; 
			--btn-generate: #1976D2; 
			--btn-reset: #E53935; 
			--btn-auto: #00A896; 
			--text-color: #212121;
			--border-color: #E0E0E0;
			--shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
			--summary-header: #37474F;
			--exception-bg: #FFF3E0;
			--exception-text: #E65100;
			--saturday-peach: #FFAB91;
			--saturday-bg: #FFF3E0;
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			text-align: right;
			direction: rtl;
			background-color: var(--light-bg-color);
			color: var(--text-color);
			padding: 20px;
			line-height: 1.6;
		}

		.container {
			max-width: 98%; /* ×¤×¨×™×¡×” ×¨×—×‘×” ×¢×œ ×›×œ ×”××¡×š */
			margin: 0 auto;
		}

		h2, h3 {
			color: var(--primary-blue);
			text-align: center;
			border-bottom: 2px solid var(--border-color);
			padding-bottom: 10px;
			margin-bottom: 20px;
		}

		/* =========================================
		   2. ×¢×™×¦×•×‘ ×›×¤×ª×•×¨×™× ×•×××©×§
		   ========================================= */
		button {
			border: none;
			padding: 12px 25px;
			margin: 5px;
			border-radius: 8px; 
			cursor: pointer;
			font-size: 16px;
			font-weight: bold;
			transition: all 0.3s ease;
			box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
			color: white;
			text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
		}

		button:hover:not(:disabled) {
			opacity: 0.9;
			transform: translateY(-2px);
			box-shadow: 0 5px 10px rgba(0, 0, 0, 0.15);
		}
		
		button:disabled {
			background-color: #cccccc !important;
			cursor: not-allowed;
		}

		#analyzeButton { background-color: var(--btn-analyze); }
		#downloadButton { background-color: var(--btn-download); }
		#generateLinkButton { background-color: var(--btn-generate); }
		#resetButton { background-color: var(--btn-reset); }
		#autoScheduleButton { background-color: var(--btn-auto); padding: 15px 40px; font-size: 19px; width: 100%; max-width: 400px; }

		/* ×›×¤×ª×•×¨×™ ×‘×—×™×¨×ª ×©×•××¨×™× (×¤×× ×œ ×¦×“×™) */
		.guard-selector-container {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			justify-content: center;
			background: #fff;
			padding: 15px;
			border-radius: 10px;
			border: 1px solid var(--border-color);
		}

		.guard-btn {
			background-color: #f0f4f7;
			color: #37474f;
			border: 1px solid #cfd8dc;
			padding: 8px 16px;
			border-radius: 20px;
			cursor: pointer;
			font-size: 13px;
			transition: all 0.2s ease;
		}

		.guard-btn.active {
			background-color: #FFC107 !important;
			color: #212121 !important;
			border-color: #FFA000;
			font-weight: bold;
			transform: scale(1.05);
			box-shadow: 0 2px 5px rgba(0,0,0,0.2);
		}

		/* =========================================
		   3. ××–×•×¨×™ ×§×œ×˜ ×•×¤×¨×™×¡×ª ×¢×•×¨×š (Side-by-Side)
		   ========================================= */
		.editor-layout-row {
			display: flex;
			gap: 20px;
			align-items: flex-start;
			margin-top: 20px;
		}

		.textarea-container {
			flex: 2; /* ××–×•×¨ ×”×˜×§×¡×˜ ×ª×•×¤×¡ ×™×•×ª×¨ ××§×•× */
		}

		.guards-selection-side-panel {
			flex: 1;
			background-color: #ffffff;
			padding: 20px;
			border-radius: 15px;
			border: 1px solid #f0f0f0;
			box-shadow: 0 4px 20px rgba(0,0,0,0.03);
			position: sticky;
			top: 20px;
		}

		textarea {
			width: 100%;
			min-height: 600px;
			padding: 15px;
			border: 1px solid var(--border-color);
			border-radius: 6px;
			font-family: monospace;
			font-size: 14px;
			box-sizing: border-box;
			resize: vertical;
		}

		/* =========================================
		   4. ×˜×‘×œ×ª ×”××©××¨×•×ª ×”×¨××©×™×ª
		   ========================================= */
		#results-container {
			width: 100%;
			margin-top: 30px;
			overflow-x: auto; /* ×××¤×©×¨ ×’×œ×™×œ×” ×¨×§ ×× ×”××¡×š ×××© ×§×˜×Ÿ */
			padding: 20px;
			box-sizing: border-box;
		}

		#schedule-table {
			width: 100%;
			max-width: 1600px;
			margin: 0 auto !important;
			border-collapse: separate;
			border-spacing: 0;
			background-color: white;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05); /* ×¦×œ ×¨×š ××•×“×¨× ×™ */
			border-radius: 15px;
			overflow: hidden;
			border: 1px solid #eee;
			table-layout: fixed !important;
		}

		#schedule-table th, #schedule-table td {
			border-bottom: 1px solid #f0f0f0;
			border-left: 1px solid #f0f0f0;
			padding: 15px 10px;
			text-align: center;
			font-size: 16px;
			transition: background-color 0.2s;
			/* ×ª×•×¡×¤×•×ª ×œ×× ×™×¢×ª ×§×¤×™×¦×•×ª */
			height: 70px;            /* ×§×™×‘×•×¢ ×’×•×‘×” ××—×™×“ ×œ×›×œ ×”×ª××™× */
			vertical-align: middle;
			overflow: visible !important; /* ×××¤×©×¨ ×œ×©× ×œ×’×“×•×œ ×‘×œ×™ ×œ×”×–×™×– ××ª ×”×ª× */
		}

		#schedule-table thead {
			background-color: var(--primary-blue);
			color: white;
		}

		/* ×¢××•×“×ª ×”×©×¢×•×ª */
		.time-slot {
			background-color: var(--secondary-blue);
			color: #475569 !important;
			font-weight: bold;
			direction: ltr !important; /* ×ª×™×§×•×Ÿ ×”×¦×’×ª ×©×¢×•×ª 02:00-06:00 */
			border-left: 2px solid #e2e8f0 !important;
		}

		/* --- ×”×“×’×©×ª ×¡×•×£ ×©×‘×•×¢ (×©×™×©×™ ×•×©×‘×ª) ×‘××¤×¨×¡×§ --- */
		/* ×¢××•×“×” 6 ×”×™× ×©×™×©×™, ×¢××•×“×” 7 ×”×™× ×©×‘×ª */
		#schedule-table th:nth-child(6), #schedule-table th:nth-child(7) {
			background-color: #ff8a65 !important;
		}

		#schedule-table td:nth-child(6), #schedule-table td:nth-child(7) {
			background-color: var(--saturday-bg) !important;
		}

		/* ××•×¤×¦×™×•× ×œ×™: ×™×•× ×¨××©×•×Ÿ (×”×¢××•×“×” ×”××—×¨×•× ×”) ×‘×¦×‘×¢ × ×™×™×˜×¨×œ×™ ×¢×“×™×Ÿ */
		#schedule-table td:last-child {
			padding-left: 20px;
		}
		

		/* =========================================
		   5. ×©××•×ª ×©×•××¨×™× (×‘×•×¢×•×ª) ×•×¦×‘×¢×™×
		   ========================================= */
		
		.person {
			display: block;
			width: fit-content;
			margin: 3px auto;
			padding: 4px 12px;
			border-radius: 50px;
			font-size: 1.5em;
			font-weight: 600;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
			cursor: default;
			border: 1px solid rgba(0,0,0,0.03);
		}

		.person:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12);
			filter: brightness(1.05);
		}

		.highlight-name {
			transform: scale(1.15) !important; /* ×”×’×“×œ×” ××ª×•× ×” ×™×•×ª×¨ ×œ×× ×™×¢×ª ×¢×™×•×•×ª */
			box-shadow: 0 0 15px rgba(0, 0, 0, 0.5) !important;
			
			/* ×©×™××•×© ×‘-outline ××‘×˜×™×— ×©×”×˜×‘×œ×” ×œ× ×ª×–×•×– ××™×œ×™××˜×¨ */
			outline: 3px solid #000 !important;
			outline-offset: 1px;
			
			z-index: 1000 !important;
			position: relative !important;
			filter: brightness(1.2) contrast(1.1) !important;
			transition: transform 0.1s ease;
		}

		/* ××¤×ª ×¦×‘×¢×™× ×‘×¡×™×¡×™×ª ×œ×©××•×ª */
		.color-×××™×¨ { background-color: #BBDEFB !important; color: #0D47A1; }
		.color-× ××¨×•×“ { background-color: #e1f5fe; color: #0277bd; }
		.color-×™×•×‘×™ { background-color: #fff8e1; color: #ff8f00; }
		/* ... ×©××¨ ×¦×‘×¢×™ ×”×©××•×ª ×©×œ×š ×™×‘×•××• ×›××Ÿ ... */
		
		/* ** ××¤×ª ×¦×‘×¢×™× ×œ×›×œ 22 ×”×©×•××¨×™× ** */
		.color-×××™×¨ { background-color: #BBDEFB !important; color: #0D47A1; } 
		.color-× ××¨×•×“ { background-color: #e1f5fe; color: #0277bd; } 
		.color-×™×•×‘×™ { background-color: #fff8e1; color: #ff8f00; } 
		.color-×˜×’× ×™×” { background-color: #43A047 !important; color: #ffffff !important; }
		.color-×™×©×™ { background-color: #f3e5f5; color: #6a1b9a; } 
		.color-×—×¡×•×Ÿ { background-color: #0D47A1 !important; color: #ffffff !important; }
		.color-×œ×™×©×¢ { background-color: #C8E6C9; color: #000000; } 
		.color-×¢×™×“×Ÿ { background-color: #eceff1; color: #D81B60; } 
		.color-×—×’×™ { background-color: #fff3e0; color: #e65100; } 
		.color-×¡×ª×™×• { background-color: #FFFF00; color: #0000FF; } 
		.color-××¡×£ { background-color: #FFECB3; color: #c62828; } 
		.color-×œ×™×× ×™ { background-color: #7E57C2 !important; color: #ffffff !important; }
		.color-× ×ª×™ {
			background-color: transparent !important; /* ××‘×˜×œ ××ª ×”×¨×§×¢ ×©×œ ×”×‘×•×¢×” */
			box-shadow: none !important;            /* ××‘×˜×œ ××ª ×”×¦×œ×œ×™×ª */
			font-size: 0 !important;               /* ××¢×œ×™× ××ª ×”×˜×§×¡×˜ "× ×ª×™" */
			cursor: help;
		}
		.color-× ×ª×™::before {
			content: "ğŸ";                          /* ××¦×™×’ ×¦×™×•×¨ ×©×œ × ×—×© */
			font-size: 28px;                       /* ×§×•×‘×¢ ××ª ×’×•×“×œ ×”× ×—×© */
			display: inline-block;
			visibility: visible;
		}
		.color-×¢×¨×Ÿ { background-color: #e8eaf6; color: #3949ab; } 
		.color-×××•×¨ { background-color: #FFFDE7; color: #212121; } 
		.color-× ×™×¨ { background-color: #FF0000; color: #FFFFFF; } 
		.color-×—×•×¨×—×” { background-color: #fce4ec; color: #d81b60; } 
		.color-×©×œ×•××™ { background-color: #A1887F !important; color: #ffffff !important; }
		.color-×™×¤×ª×— { background-color: #f0f4c3; color: #827717; } 
		.color-×—×‘×¨×•× ×™ { background-color: #c8e6c9; color: #33691e; } 
		.color-×•×™×§×˜×•×¨ { background-color: #FFB300 !important; color: #ffffff !important; }
				.color-×’×•×œ×Ÿ {
			background-color: #D32F2F !important;
			background-image: conic-gradient(#ffffff 90deg, transparent 90deg 180deg, #ffffff 180deg 270deg, transparent 270deg);
			background-size: 10px 10px;
			
			/* ×©×™× ×•×™ ×¦×‘×¢ ×”×˜×§×¡×˜ ×œ×œ×‘×Ÿ */
			color: #ffffff !important; 
			font-weight: bold;
			
			/* ×”×•×¡×¤×ª ××¡×’×¨×ª ×©×—×•×¨×” ×¡×‘×™×‘ ×”×˜×§×¡×˜ (×”×‘×œ×˜×”) */
			text-shadow: 
				-1px -1px 0 #000,  
				 1px -1px 0 #000,
				-1px  1px 0 #000,
				 1px  1px 0 #000;
		}

		/* =========================================
		   6. ×˜×‘×œ××•×ª ×¡×™×›×•× ×•×—×¨×™×’×•×ª
		   ========================================= */
		#summary-table, #exceptions-table {
			width: 95%;
			margin: 30px auto;
			border-collapse: separate;
			border-spacing: 0;
			box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
			border-radius: 12px;
			overflow: hidden;
			border: 1px solid #f0f0f0;
		}

		#summary-table thead { background-color: var(--summary-header); color: white; }
		#exceptions-table thead { background-color: #ef4444; color: white; }

		#summary-table th, #summary-table td,Â 
		#exceptions-table th, #exceptions-table td {
			padding: 16px;
			text-align: center;
			border-bottom: 1px solid #f8fafc;
			font-size: 15px;
		}
		
		#summary-table tr:last-child td, #exceptions-table tr:last-child td {
			border-bottom: none;
		}

		/* ×¡×˜×˜×•×¡×™× ×‘×¡×™×›×•× */
		.shifts-5-count { background-color: #E3F2FD !important; color: #0D47A1 !important; font-weight: bold; border-right: 6px solid #1976D2; }
		.shifts-4-count { background-color: #C8E6C9; color: #1B5E20; }
		.low-shifts { background-color: #FBECEC; color: var(--accent-red); font-weight: bold; }

		/* =========================================
		   7. ×”×ª×××” ×œ× ×™×™×“
		   ========================================= */
		@media (max-width: 1024px) {
			.editor-layout-row {
				flex-direction: column;
			}
			.guards-selection-side-panel {
				position: static;
				width: 100%;
			}
			#schedule-table {
				display: block;
				overflow-x: auto;
			}
		}
		
		/* ×›×•×ª×¨×ª ××•×“×¨× ×™×ª ×œ×§×•×‘×¥ ×”××•×¨×“ */
		.modern-main-header {
			text-align: center;
			margin: 30px 0;
			font-size: 2.5em;
			font-weight: 800;
			background: linear-gradient(135deg, var(--primary-blue), #004D40);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			position: relative;
			display: block;
			width: fit-content;
			margin-left: auto;
			margin-right: auto;
		}

		/* ×¤×¡ ×“×§×•×¨×˜×™×‘×™ ××ª×—×ª ×œ×›×•×ª×¨×ª */
		.modern-main-header {
			text-align: center;
			margin: 40px auto;
			padding: 15px 40px;
			font-size: 2.2em;
			font-weight: 700;
			background-color: white;
			border-radius: 100px; /* ×¢×™×’×•×œ ××œ× */
			box-shadow: 0 10px 25px rgba(0,0,0,0.08); /* ×¦×œ ×¨×š ×××•×“ */
			border: 1px solid #f0f0f0;
			color: var(--primary-blue);
			width: fit-content;
		}
		
		/* =========================================
		   8. ×¢×™×¦×•×‘ ×©×•×¨×ª ×”×œ×™×•×•×™ 07:40 - ××¤×§×˜ ×‘×•×œ×˜ ×•×ª×œ×ª-×××“
		   ========================================= */	

		/* ×”×©×•×¨×” ×›×•×œ×” - ××§×‘×œ×ª ×¦×œ ×›×“×™ "×œ×¦×•×£" ××¢×œ ×”×©××¨ */
		.red-assistance-shift {
			box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
			position: relative;
			z-index: 5;
		}

		/* ×”×’×“×¨×•×ª ×›×œ×œ×™×•×ª ×œ×ª××™ ×”×©×•×¨×” (×”×ª×›×œ×ª ×”××•×›×¨) */
		.red-assistance-shift td {
			background-color: #E1F5FE !important; 
			color: #000000 !important;           
			font-weight: 800 !important;
			border-top: 3px solid #000000 !important;
			border-bottom: 3px solid #000000 !important;
		}

		/* ×”×—×¨×’×ª ×™××™ ×©×™×©×™ ×•×©×‘×ª (×¢××•×“×•×ª 6 ×•-7) - ×”×•×¤×›×™× ×œ××¤×¨×¡×§ ×¢× ××¡×’×¨×ª ×©×—×•×¨×” */
		#schedule-table tbody tr.red-assistance-shift td:nth-child(6),
		#schedule-table tbody tr.red-assistance-shift td:nth-child(7) {
			background-color: var(--saturday-bg) !important;
			border-top: 3px solid #000000 !important;
			border-bottom: 3px solid #000000 !important;
		}

		/* ×¡×’×™×¨×ª ×”××¡×’×¨×ª ×”×©×—×•×¨×” ×‘×¦×“×“×™× */
		.red-assistance-shift td:first-child {
			border-right: 3px solid #000000 !important;
		}
		.red-assistance-shift td:last-child {
			border-left: 3px solid #000000 !important;
		}

		/* ×”×’× ×” ×¢×œ ×¢××•×“×ª ×”×©×¢×•×ª ×©×œ× ×ª××‘×“ ××ª ×”×¦×‘×¢ ×”×›×—×•×œ ×©×œ×” */
		.red-assistance-shift td.time-slot {
			background-color: var(--secondary-blue) !important;
			color: white !important;
		}
		
		/* =========================================
		   9. ×¢×™×¦×•×‘ ×‘×—×™×¨×ª ×ª××¨×™×š (×¢×“×™×Ÿ ×•×§×•××¤×§×˜×™)
		   ========================================= */
		.date-input-container {
			margin: 20px auto;
			text-align: center;
			background: #ffffff;
			padding: 15px;
			border-radius: 10px;
			box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05); /* ×¦×œ ×¢×“×™×Ÿ ×××•×“ */
			max-width: 380px; /* ×¨×•×—×‘ ××¦×•××¦× */
			border: 1px solid var(--border-color);
		}

		.date-input-container label {
			font-size: 18px; /* ×’×•×“×œ ×˜×§×¡×˜ ××¢×•×“×Ÿ */
			font-weight: 600;
			color: var(--text-color);
			display: block;
			margin-bottom: 8px;
		}

		.date-input-container input[type="date"] {
			font-size: 16px; 
			padding: 8px 12px;
			border: 1px solid var(--border-color);
			border-radius: 6px;
			outline: none;
			cursor: pointer;
			font-family: inherit;
			color: var(--text-color);
			transition: all 0.2s ease;
		}

		/* ××¤×§×˜ ×§×˜×Ÿ ×‘××¢×‘×¨ ×¢×›×‘×¨ */
		.date-input-container input[type="date"]:hover {
			border-color: var(--secondary-blue);
			background-color: #f9fbfb;
		}

		.date-input-container input[type="date"]:focus {
			border-color: var(--primary-blue);
			box-shadow: 0 0 5px rgba(0, 121, 107, 0.15);
		}
		
		/* ×¢×™×¦×•×‘ ×©× ×”×™×•× - ×©×—×•×¨ ×•×‘×•×œ×˜ */
		.day-header-name {
			color: #FFFFFF !important; /* ×œ×‘×Ÿ ×‘×•×”×§ */
			display: block;
			font-weight: 700;
			font-size: 1.5em;
			text-transform: uppercase;
			letter-spacing: 1px;
		}

		/* ×¢×™×¦×•×‘ ×”×ª××¨×™×š - ×œ×‘×Ÿ ×•×§×˜×Ÿ ×™×•×ª×¨ */
		.date-text {
			color: #FFFFFF !important; /* ×œ×‘×Ÿ */
			display: block;
			font-size: 1.2em;           /* ×§×˜×Ÿ ×™×•×ª×¨ ××©× ×”×™×•× */
			font-weight: normal;
			margin-top: 2px;
		}

		/* ×”×¡×ª×¨×ª ×”×•×“×¢×ª ×§×™×©×•×¨ ×›×‘×¨×™×¨×ª ××—×“×œ */
		#link-message { display: none; }

		/* ××—×œ×§×•×ª ××¦×‘ ×©×—×¡×¨×• */
		.needs-selection { background: #ffebee !important; color:#b71c1c !important; font-weight:700; }
		.ok-shift { background: #ffffff; }
		.night-shift-ok { background: #f3f7ff; }
		.warning-text { color:#d32f2f; font-weight:700; }
		.night-limit-ok { color:#1b5e20; font-weight:700; }
		.night-limit-fail { color:#b71c1c; font-weight:700; }
		.night-limit-fail-row { background:#ffebee; }

		/* ×¢×™×¦×•×‘ ×©×•×¨×ª ×—×™×¤×•×© ×©×•××¨×™× */
		#guardSearch {
			width: 100%;
			padding: 10px;
			margin-bottom: 12px;
			border: 1px solid var(--border-color);
			border-radius: 20px;
			font-size: 14px;
			outline: none;
		}
		
		/* ×× ×™×¢×ª ×¡×™××•×Ÿ ×˜×§×¡×˜ ×‘×‘×•×¢×•×ª ×”×©×•××¨×™× */
		.person {
			user-select: none;
			-webkit-user-select: none;
		}

		/* ××¤×§×˜ ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨×™× */
		button:active {
			transform: scale(0.96) !important;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
		}

		/* ×©×™×¤×•×¨ ××¨××” ×ª×™×‘×ª ×”×˜×§×¡×˜ */
		textarea:focus {
			outline: none;
			border-color: var(--secondary-blue);
			box-shadow: 0 0 0 3px rgba(77, 182, 172, 0.1);
		}
		
		/* =========================================
		   ×× ×™××¦×™×™×ª ×“×’×œ ××ª× ×¤× ×£
		   ========================================= */
		@keyframes wave-flag {
			0% { transform: perspective(100px) rotateY(0deg) skewY(0deg); }
			25% { transform: perspective(100px) rotateY(15deg) skewY(2deg); }
			50% { transform: perspective(100px) rotateY(0deg) skewY(0deg); }
			75% { transform: perspective(100px) rotateY(-15deg) skewY(-2deg); }
			100% { transform: perspective(100px) rotateY(0deg) skewY(0deg); }
		}

		.waving-flag {
			display: inline-block;
			/* ×”×¤×¢×œ×ª ×”×× ×™××¦×™×”: ×©× ×”×¨×™×§×•×“, ××©×š ×–××Ÿ, ××™× ×¡×•×¤×™, ×œ×™× ××¨×™ */
			animation: wave-flag 2.5s infinite ease-in-out;
			transform-origin: left center; /* ×”×“×’×œ "××—×•×‘×¨" ×œ×ª×•×¨×Ÿ ×‘×¦×“ ×©×××œ */
			filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3)); /* ×¦×œ ×¢××•×§ ×™×•×ª×¨ */
		}
		
	</style>
</head>
<body onload="initializeData(); document.getElementById('analyzeButton').click();">

<div class="container">
    <h2>×× ×ª×— ×˜×‘×œ×ª ××©××¨×•×ª ×©×‘×•×¢×™×ª ğŸ“…</h2>
    
    <div id="input-section-wrapper">
        
        <div id="data-source-section">
            <h3>× ×ª×•× ×™ ××©××¨×•×ª ×œ×¢×¨×™×›×” ×•××§×•×¨ ×”× ×ª×•× ×™× ğŸ“</h3>
			
			<h3>××©×™×›×ª × ×ª×•× ×™× ×-Google Sheet Web App â˜ï¸</h3>
			
			<p class="file-format-info">
				×”×›× ×¡ ××ª ×›×ª×•×‘×ª ×”-Web App ×©×œ Google Apps Script (×©××—×–×™×¨×” ××ª × ×ª×•× ×™ ×”×¡×™×“×•×¨ ×‘×¤×•×¨××˜ ×˜×§×¡×˜/CSV)
			</p>
			
			<div style="text-align: center; margin-bottom: 15px;">
				<a href="https://docs.google.com/spreadsheets/d/1NXgjKC-0j4blUQawwzz4lMEhswA561GKxAoSJO5ie_s/edit?gid=0#gid=0" target="_blank" style="text-decoration: none;">
					<button style="background-color: #f4b400; color: #212121; padding: 10px 30px; font-weight: bold; font-size: 16px;">
						×¤×ª×— ×’×™×œ×™×•×Ÿ × ×ª×•× ×™× (Google Sheets) ğŸ“„
					</button>
				</a>
			</div>
			<div style="display: flex; gap: 10px; margin-bottom: 5px; margin-top: 10px;"> <input type="text" id="googleSheetUrl" placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×›×ª×•×‘×ª ×”-Web App..." style="flex-grow: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; direction: ltr; text-align: left;">
				<button id="fetchFromSheetButton" style="background-color: #4CAF50; color: white; padding: 10px 15px; min-width: 120px;">××©×•×š × ×ª×•× ×™× ğŸ”„</button>
			</div>
			
			<p id="fetch-status" style="text-align: center; display: none; font-weight: bold; margin-top: 10px;"></p>
            
            <div class="date-input-container">
                <label for="startDate">×ª××¨×™×š ×™×•× ×©× ×™ (×ª×—×™×œ×ª ×©×‘×•×¢):</label>
                <input type="date" id="startDate" required>
            </div>
            
			<div class="editor-layout-row">
				
				<div class="textarea-container">
					<h3>× ×ª×•× ×™ ××©××¨×•×ª ×œ×¢×¨×™×›×” ×•××§×•×¨ ×”× ×ª×•× ×™× ğŸ“</h3>
					<textarea id="dataToAnalyze" 
						title="× ×ª×•× ×™ ××©××¨×•×ª ×œ×¢×¨×™×›×” ×•× ×™×ª×•×—"
						placeholder="×”×“×‘×§ ××ª × ×ª×•× ×™ ×”××©××¨×•×ª ×›××Ÿ (×¤×•×¨××˜: ×™×•× ×©× ×™\n×©×¢×•×ª ×¢×•×‘×“1 ×¢×•×‘×“2...)">
					</textarea>
				</div>

				<div class="guards-selection-side-panel">
					<h3>×‘×—×™×¨×ª ×©×•××¨×™× ×œ×™×¢×“ ×©×œ 5 ××©××¨×•×ª ğŸ†</h3>
					<p class="file-format-info" style="font-size: 0.85em; margin-bottom: 10px;">
						×œ×—×¥ ×¢×œ ×”×©×•××¨×™× ×©×—×™×™×‘×™× ×œ×”×’×™×¢ ×œ-5 ××©××¨×•×ª (×¢×“×™×¤×•×ª ×‘×©×™×‘×•×¥):
					</p>
					<div id="guardButtonsContainer" class="guard-selector-container" style="box-shadow: none; border: 1px solid #eee; background: #fafafa;">
						</div>
					<textarea id="guardsFor5Shifts" style="display:none;"></textarea>
				</div>

			</div>
			            
            <div id="button-group">
                <button id="analyzeButton">× ×ª×— × ×ª×•× ×™× ğŸ”</button>
                <button id="downloadButton">×”×•×¨×“ ×§×•×‘×¥ CSV â¬‡ï¸</button>
                <button id="generateLinkButton">×”×•×¨×“ ×˜×‘×œ×ª HTML ××¢×•×¦×‘×ª ğŸ’¾</button>Â 
                <button id="resetButton">××¤×¡ × ×ª×•× ×™× ğŸ—‘ï¸</button>
            </div>
        </div>
        
    </div>
    
    <div id="main-button-wrapper">
		<button id="quickFetchButton" style="background-color: var(--btn-generate);">××©×•×š × ×ª×•× ×™× ××”×™×¨ ğŸ”„</button>
        <button id="autoScheduleButton">×¡×“×¨ ××•×˜×•××˜×™ ğŸ¤–</button>
    </div>

    <div id="results-container" style="text-align: center;">
        <p id="initial-message">×”×˜×¢×™× ×” ×”×¨××©×•× ×™×ª ×ª×¤×¢×™×œ ××ª ×”× ×™×ª×•×— ××•×˜×•××˜×™×ª.</p>
    </div>

    <div id="link-message">
        <p>âœ… ×§×•×‘×¥ HTML ×”×•×¨×“ ×‘×”×¦×œ×—×”!</p>
    </div>
</div>

    <script>
        // ××©×ª× ×” ×’×œ×•×‘×œ×™ ×œ×©××™×¨×ª ×§×•×“ ×”-HTML ×©×œ ×”×˜×‘×œ×” ×”××¢×•×¦×‘×ª
        let lastRenderedTableHTML = '';

        // ** × ×ª×•× ×™ ××©××¨×•×ª ×œ×“×•×’×× (×”×©××¨×ª×™ ××ª ×”××©×ª× ×” ×”×’×œ×•×‘×œ×™ ×¨×™×§ ×›×“×™ ×©×”××©×ª××© ×™×–×™×Ÿ ××ª × ×ª×•× ×™×•) **
        const INITIAL_SCHEDULE_DATA = ``;Â 

        // ×”×’×“×¨×•×ª ×§×‘×•×¢×•×ª
        const MIN_REQUIRED = 4; // *** ××™×œ×•×¥: ××™× ×™××•× 3 ××©××¨×•×ª ***
        const MAX_ALLOWED = 5;
        const MAX_NIGHT_2_6 = 2; // ××§×¡×™××•× ×©××™×¨×•×ª ×‘×©×¢×•×ª 02:00-06:00
        const MAX_ITERATIONS = 10; // ××¡×¤×¨ × ×™×¡×™×•× ×•×ª ×¡×™×“×•×¨ ××•×˜×•××˜×™
        const EXPECTED_DAYS = ['×™×•× ×©× ×™', '×™×•× ×©×œ×™×©×™', '×™×•× ×¨×‘×™×¢×™', '×™×•× ×—××™×©×™', '×™×•× ×©×™×©×™', '×™×•× ×©×‘×ª', '×™×•× ×¨××©×•×Ÿ'];
        
        const EXPECTED_TIME_SLOTS = [
            '×œ×™×•×•×™ 07:40 (Assist)',      // 0
            '02:00 - 06:00 (Night)',     // 1
            '06:00 - 10:00',             // 2
            '10:00 - 14:00',             // 3
            '14:00 - 18:00',             // 4
            '18:00 - 22:00',             // 5
            '22:00 - 02:00 (Night)'      // 6
        ];

        // ××–×”×™ ××©××¨×•×ª ×§×¨×™×˜×™×™×
        const ASSIST_SHIFT_INDEX = EXPECTED_TIME_SLOTS.indexOf('×œ×™×•×•×™ 07:40 (Assist)'); 
        const NIGHT_SHIFT_2_6_INDEX = EXPECTED_TIME_SLOTS.indexOf('02:00 - 06:00 (Night)');
        const NIGHT_SHIFT_22_2_INDEX = EXPECTED_TIME_SLOTS.indexOf('22:00 - 02:00 (Night)');
        const MORNING_SHIFT_6_10_INDEX = EXPECTED_TIME_SLOTS.indexOf('06:00 - 10:00');
        const MORNING_SHIFT_10_14_INDEX = EXPECTED_TIME_SLOTS.indexOf('10:00 - 14:00'); 
        const AFTERNOON_SHIFT_14_18_INDEX = EXPECTED_TIME_SLOTS.indexOf('14:00 - 18:00');
        const NIGHT_SHIFT_02_06_INDEX = NIGHT_SHIFT_2_6_INDEX; // ×§×‘×•×¢ ×©× ×•×¡×£ ×œ×ª×™×§×•×Ÿ ×©×’×™××ª ReferenceError

        // ** ×—×“×©: ×–×™×”×•×™ ××©××¨×•×ª ×¢×•×§×‘×•×ª ×©×™×•×¦×¨×•×ª ×‘×¢×™×™×ª ×× ×•×—×ª 8 ×©×¢×•×ª **
        const CONSECUTIVE_SHIFT_CHECK = {
            [EXPECTED_TIME_SLOTS.indexOf('18:00 - 22:00')]: EXPECTED_TIME_SLOTS.indexOf('14:00 - 18:00'),
            [EXPECTED_TIME_SLOTS.indexOf('22:00 - 02:00 (Night)')]: EXPECTED_TIME_SLOTS.indexOf('18:00 - 22:00'),
        };

        // ××¤×ª ×¦×‘×¢×™× (×¨×©×™××ª ×”×¢×•×‘×“×™× ×”×–××™× ×™× ×œ×¡×™×“×•×¨)
        const colorMap = {
Â  Â  Â  Â  Â  Â  '×××™×¨': 'color-×××™×¨', '× ××¨×•×“': 'color-× ××¨×•×“', '×™×•×‘×™': 'color-×™×•×‘×™', '×˜×’× ×™×”': 'color-×˜×’× ×™×”',
Â  Â  Â  Â  Â  Â  '×™×©×™': 'color-×™×©×™', '×’×•×œ×Ÿ': 'color-×’×•×œ×Ÿ', '×—×¡×•×Ÿ': 'color-×—×¡×•×Ÿ', '×œ×™×©×¢': 'color-×œ×™×©×¢',
Â  Â  Â  Â  Â  Â  '×¢×™×“×Ÿ': 'color-×¢×™×“×Ÿ', '×—×’×™': 'color-×—×’×™', '×¡×ª×™×•': 'color-×¡×ª×™×•', '××¡×£': 'color-××¡×£',
Â  Â  Â  Â  Â  Â  '×œ×™×× ×™': 'color-×œ×™×× ×™', '× ×ª×™': 'color-× ×ª×™', '×¢×¨×Ÿ': 'color-×¢×¨×Ÿ', '×××•×¨': 'color-×××•×¨',
Â  Â  Â  Â  Â  Â  '× ×™×¨': 'color-× ×™×¨', '×—×•×¨×—×”': 'color-×—×•×¨×—×”', '×©×œ×•××™': 'color-×©×œ×•××™', '×™×¤×ª×—': 'color-×™×¤×ª×—',
Â  Â  Â  Â  Â  Â  '×—×‘×¨×•× ×™': 'color-×—×‘×¨×•× ×™', '×•×™×§×˜×•×¨': 'color-×•×™×§×˜×•×¨',
Â  Â  Â  Â  };

        /**
         * ×¤×•× ×§×¦×™×” ×œ××ª×—×•×œ× ×™× ×•×”×¦×‘×ª ×ª××¨×™×š ×™×•× ×¨××©×•×Ÿ (×”×™×•× ×”× ×•×›×—×™)
         */
		function initializeData() {
			document.getElementById('dataToAnalyze').value = INITIAL_SCHEDULE_DATA; 
			
			const today = new Date();
			let dayOfWeek = today.getDay(); // 0 = ×¨××©×•×Ÿ, 1 = ×©× ×™...
			
			// ×—×™×©×•×‘ ×”××¨×—×§ ×œ×™×•× ×©× ×™ ×”×§×¨×•×‘/×”× ×•×›×—×™
			// ×× ×”×™×•× ×™×•× ×¨××©×•×Ÿ, × ×œ×š ×™×•× ××—×“ ×§×“×™××”. ×× ×™×•× ××—×¨, × ×—×–×•×¨ ×œ×™×•× ×©× ×™ ×©×œ ×”×©×‘×•×¢ ×”× ×•×›×—×™.
			let diffToMonday = (dayOfWeek === 0) ? -1 : dayOfWeek - 1;
			today.setDate(today.getDate() - diffToMonday);
			
			const formattedDate = today.toISOString().split('T')[0];
			// ×©×™× ×•×™ ×”×›×•×ª×¨×ª ×‘×ª×¦×•×’×” ×œ×™×•× ×©× ×™
			const dateLabel = document.querySelector('label[for="startDate"]');
			if (dateLabel) dateLabel.textContent = "×ª××¨×™×š ×™×•× ×©× ×™ (×ª×—×™×œ×ª ×©×‘×•×¢):";
			
			document.getElementById('startDate').value = formattedDate;

			const savedUrl = localStorage.getItem('googleSheetUrl');
			if (savedUrl) {
				document.getElementById('googleSheetUrl').value = savedUrl;
			}
			
			if (typeof generateGuardsButtons === "function") generateGuardsButtons();
		}

        /**
         * ×¤×•× ×§×¦×™×” ×©××§×‘×œ×ª ×ª××¨×™×š ×”×ª×—×œ×” ×•××—×–×™×¨×” ××¢×¨×š ×ª××¨×™×›×™× ×œ×©×‘×•×¢.
         */
        function getDatesForWeek(startDateString) {
            const dates = [];
            const [year, month, day] = startDateString.split('-');
            const startDate = new Date(year, month - 1, day);
            
            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dayStr = String(currentDate.getDate()).padStart(2, '0');
                const monthStr = String(currentDate.getMonth() + 1).padStart(2, '0');
                
                dates.push(`${dayStr}/${monthStr}`);
            }
            return dates;
        }

        /**
         * ×¤×•× ×§×¦×™×” ×œ× ×™×§×•×™ ××’×¨×¡×™×‘×™ ×©×œ ×©×•×¨×” ××ª×•×•×™× ×‘×œ×ª×™ × ×¨××™× ×•×¨×™×•×•×— (× ×©××¨×ª ×–×”×”)
         */
        function aggressiveClean(line) {
            return line.replace(/[\u0000-\u001F\u007F-\u009F\uFEFF\u00A0]/g, '').trim();
        }
        
        /**
         * ×¤×•× ×§×¦×™×” ×œ×¢×™×‘×•×“ ×˜×§×¡×˜ ×¢× ×—×œ×•×§×” ×× ×›×™×ª ×œ×¤×™ ×™××™× (× ×©××¨×ª ×–×”×”)
         */
        function parseVerticalText(text) {
            const lines = text.split(/\r?\n|\r/);Â 
            const rawDayData = {};
            let currentDay = null;
            
            const timeSlotCheckMap = {};
            EXPECTED_TIME_SLOTS.forEach(slot => {
                const timePart = slot.split('(')[0].trim();
                timeSlotCheckMap[timePart] = slot;
            });
            

            lines.forEach(line => {
                const cleanedLine = aggressiveClean(line);
                
                if (cleanedLine.length === 0) {
                    return;
                }

                const dayMatch = EXPECTED_DAYS.find(day => cleanedLine === day || cleanedLine.startsWith(day));

                if (dayMatch) {
                    currentDay = dayMatch;
                    rawDayData[currentDay] = [];
                } else if (currentDay) {
                    const parts = line.split(/\s{2,}|\t/).map(p => p.trim());Â 
                    const timeSlotString = parts[0];
                    
                    const isTimeSlot = Object.keys(timeSlotCheckMap).some(timePart => timeSlotString && timeSlotString.startsWith(timePart));
                    const isAssistanceSlot = timeSlotString === '×œ×™×•×•×™ 07:40';

                    if (parts.length > 0 && (isTimeSlot || isAssistanceSlot)) {
                        const potentialNames = parts.slice(1);
                        const names = potentialNames.filter(name => name.length > 0).map(name => name.trim());
                        rawDayData[currentDay].push(names.join(','));
                    }
                }
            });

            const daysFound = Object.keys(rawDayData);
            
            if (daysFound.length === 0) {
                return { error: '×œ× × ××¦××• × ×ª×•× ×™× ×ª×§×™× ×™× ××• ×©×œ× ×–×•×”×• ×™××™× ×‘×¤×•×¨××˜ × ×›×•×Ÿ. ×•×“× ×©×”× ×ª×•× ×™× ××ª×—×™×œ×™× ×‘"×™×•× ×©× ×™".' };
            }

            const scheduleTable = [];Â 
            for (let i = 0; i < EXPECTED_TIME_SLOTS.length; i++) {
                const row = [];
                for (let j = 0; j < EXPECTED_DAYS.length; j++) {
                    const day = EXPECTED_DAYS[j];
                    const dayShifts = rawDayData[day];
                    
                    if (!dayShifts) {
                           return { error: `×©×’×™××”: ×™×•× **${day}** ×—×¡×¨ ×œ×—×œ×•×˜×™×Ÿ ×‘× ×ª×•× ×™×.` };
                    }Â 
                    
                    if (dayShifts.length !== EXPECTED_TIME_SLOTS.length) {
                        return { error: `×©×’×™××” ×‘×™×•× **${day}**: × ××¦××• ×¨×§ ${dayShifts?.length || 0} ××©××¨×•×ª ×‘××§×•× ${EXPECTED_TIME_SLOTS.length} ××©××¨×•×ª. ×™×© ×œ×ª×§×Ÿ ××ª ×›××•×ª ×”×©×•×¨×•×ª ×‘×™×•× ×–×”.` };
                    }
                    row.push(dayShifts[i]);
                }
                scheduleTable.push(row);
            }

            return { days: EXPECTED_DAYS, data: scheduleTable };
        }

        /**
         * ×¤×•× ×§×¦×™×” ×œ×‘× ×™×™×ª ×”×˜×‘×œ×” ×•×‘×™×¦×•×¢ ×”× ×™×ª×•×— - ×›×•×œ×œ ×”×¦×’×ª ×ª××¨×™×›×™×
         */
        function renderSchedule(parsedData) {
            const resultsContainer = document.getElementById('results-container');
            const startDateString = document.getElementById('startDate').value;

            if (parsedData.error) {
                resultsContainer.innerHTML = `<p class="warning-text">âŒ ×©×’×™××ª × ×ª×•× ×™×: ${parsedData.error}</p>`;
                return;
            }
            
            if (!startDateString) {
                 resultsContainer.innerHTML = `<p class="warning-text">âŒ ×× × ×‘×—×¨ ×ª××¨×™×š ×”×ª×—×œ×” (×™×•× ×¨××©×•×Ÿ) ×œ×¤× ×™ ×”× ×™×ª×•×—.</p>`;
                return;
            }

            const datesForWeek = getDatesForWeek(startDateString);
            const { days: dayHeaders, data: scheduleData } = parsedData;
			
			const guardsFor5Text = document.getElementById('guardsFor5Shifts').value;
            const guardsFor5Set = new Set(guardsFor5Text.split(/[,\n]/).map(name => name.trim()).filter(name => name !== ''));

            // **1. ×™×¦×™×¨×ª HTML ×¢×‘×•×¨ ×”×˜×‘×œ×” ×”×× ×•×ª×—×ª**
            let tableHTML = '<h3 style="text-align: center;">×˜×‘×œ×ª ××©××¨×•×ª ×× ×•×ª×—×ª</h3>';
            
            tableHTML += `<p class="file-format-info" style="text-align: center; color: var(--primary-blue);">**×”×’×“×¨×•×ª:** ××©××¨×ª ×™×•× (06:00-22:00): 1 ×¢×•×‘×“. ××©××¨×ª ×œ×™×œ×” (02:00-06:00, 22:00-02:00): ×¢×“ 2 ×¢×•×‘×“×™×. **××™× ×™××•× ×©×‘×•×¢×™: ${MIN_REQUIRED} ××©××¨×•×ª (×œ× ×›×•×œ×œ ×œ×™×•×•×™).**</p>`;

            // ×™×¦×™×¨×ª ×˜×‘×œ×ª ×”× ×ª×•× ×™× ×”×¨××©×™×ª
            let scheduleTableHTML = '<table id="schedule-table"><thead><tr><th>×©×¢×•×ª / ×™×•×</th>';
            
			// ×”×•×¡×¤×ª ×›×•×ª×¨×•×ª ×”×™××™× - ×©× ×”×™×•× ×‘×©×—×•×¨ ×•×ª××¨×™×š ×œ×‘×Ÿ ×•×§×˜×Ÿ ××ª×—×ª×™×•
            dayHeaders.forEach((day, index) => {
                // 1. ×§×™×¦×•×¨ "×™×•× ×©× ×™" ×œ-"×©× ×™"
                const shortDay = day.replace('×™×•× ', '');
                
                // 2. ×‘× ×™×™×ª ×ª× ×”×›×•×ª×¨×ª ×¢× ×”×§×œ××¡×™× ×”××¢×•×¦×‘×™×
                scheduleTableHTML += `
                    <th>
                        <span class="day-header-name">${shortDay}</span>
                        <span class="date-text">${datesForWeek[index]}</span>
                    </th>`;
            });

            // ×¡×’×™×¨×ª ×©×•×¨×ª ×”×›×•×ª×¨×ª ×•×ª×—×™×œ×ª ×’×•×£ ×”×˜×‘×œ×”
            scheduleTableHTML += '</tr></thead><tbody>';

            
            const allShifts = {};
            const nightShift2to6Count = {};Â 
            const dailyCheck = {};
			const exceptions = [];
            
            scheduleData.forEach((row, rowIndex) => {
                const timeSlotFull = EXPECTED_TIME_SLOTS[rowIndex];
                const isNightShift = timeSlotFull.includes('(Night)');
                const isAssistanceShift = timeSlotFull.includes('(Assist)');Â 
                const isNight2to6 = rowIndex === NIGHT_SHIFT_2_6_INDEX;
                const timeSlotDisplay = timeSlotFull.replace(' (Night)', '').replace(' (Assist)', '');
                
                const maxAllowedInShift = isNightShift ? 2 : 1;Â 
                
                const rowClass = isAssistanceShift ? 'red-assistance-shift' : '';
                
                scheduleTableHTML += `<tr class="${rowClass}"><td class="time-slot">${timeSlotDisplay}</td>`;

                row.forEach((cellContent, colIndex) => {
                    const day = dayHeaders[colIndex];
                    const names = cellContent.split(',').filter(name => name.trim().length > 0);
                    const numNames = names.length;
                    
                    if (!dailyCheck[day]) { dailyCheck[day] = new Set(); }
                    
                    let dailyDuplicateFound = false;
                    let consecutiveShiftViolation = false; 
                    
                    names.forEach(name => {
                        const cleanedName = name.trim();
                        
                        // 1. ×‘×“×™×§×ª ×›×¤×™×œ×•×ª ×™×•××™×ª (×œ× ×›×•×œ×œ ×œ×™×•×•×™ 07:40)
						if (dailyCheck[day].has(cleanedName)) { 
							exceptions.push({
								day: day,
								slot: timeSlotDisplay,
								name: cleanedName,
								msg: "×›×¤×™×œ×•×ª: ××©×•×‘×¥ ×‘×™×•×ª×¨ ×××©××¨×ª ××—×ª ×‘×™×•×"
							});
						}
						
                        // 2. ×‘×“×™×§×ª ×¨×¦×£ ××©××¨×•×ª (8 ×©×¢×•×ª ×× ×•×—×” ×‘××•×ª×• ×™×•×)
                        const prevShiftIndex = CONSECUTIVE_SHIFT_CHECK[rowIndex];
                        if (prevShiftIndex !== undefined) {
                            const prevShiftNames = scheduleData[prevShiftIndex][colIndex].split(',').map(n => n.trim()).filter(n => n.length > 0);
                            if (prevShiftNames.includes(cleanedName)) {
                                consecutiveShiftViolation = true; 
                            }
                        }
                        

                        if (cleanedName) { 
                            if (!isAssistanceShift) { 
								dailyCheck[day].add(cleanedName);
							}
                            
                            // 3. ××™×¡×•×£ ×›×œ×œ×™ ×œ×ª×“×™×¨×•×ª ×©×‘×•×¢×™×ª (*** ×¨×§ ××©××¨×•×ª ×œ×-×œ×™×•×•×™ ***)
                            if (!isAssistanceShift) { 
                                allShifts[cleanedName] = (allShifts[cleanedName] || 0) + 1;
                            }

                            // 4. **××™×¡×•×£ ×œ×ª×“×™×¨×•×ª ××©××¨×ª 02:00-06:00**
                            if (isNight2to6) {
                                nightShift2to6Count[cleanedName] = (nightShift2to6Count[cleanedName] || 0) + 1;
                            }
                        }
                    });
                    
                    // --- ×‘×“×™×§×•×ª ××›×™×¤×ª ×× ×•×—×ª ×œ×™×œ×” ×—××•×¨×•×ª (×—×“×©) ---
                    let nightRestViolation = false; // 22-02 ××ª××•×œ -> 06-10 / 10-14 ×”×™×•×
                    let sameDayNightBlockViolation = false; // 02-06 ×”×™×•× -> 06-10 / 10-14 / 14-18 ×”×™×•×
                    let consecutiveNightViolation = false; // 22-02 ××ª××•×œ -> 02-06 ×”×™×•×

                    // 5.1 Check 22:00-02:00 (Previous Night) to Day (Next Day Block until 14:00)
                    if (colIndex > 0 && (rowIndex === MORNING_SHIFT_6_10_INDEX || rowIndex === MORNING_SHIFT_10_14_INDEX)) { 
                        const prevDayIndex = colIndex - 1;
                        const prevNightShiftCell = scheduleData[NIGHT_SHIFT_22_2_INDEX][prevDayIndex];
                        const prevNightNames = prevNightShiftCell.split(',').map(n => n.trim()).filter(n => n.length > 0);

                        names.forEach(currentName => {
							if (prevNightNames.includes(currentName.trim())) { 
								// ×× ×—× ×• ××•×¡×™×¤×™× ××ª ×”×—×¨×™×’×” ×œ×¨×©×™××”
								exceptions.push({
									day: day,
									slot: timeSlotDisplay,
									name: currentName.trim(),
									msg: "×”×¤×¨×ª ×× ×•×—×ª ×œ×™×œ×”: ×©××¨ ×‘×œ×™×œ×” (22-02) ×•××©×•×‘×¥ ×œ×¤× ×™ 14:00 ×œ××—×¨×ª"
								});
								nightRestViolation = true; // × ×©××™×¨ ××ª ×”××©×ª× ×” ×›-true ×›×“×™ ×©×”×œ×•×’×™×§×” ×ª×“×¢ ×©×”×™×™×ª×” ×—×¨×™×’×”
							}
                        });
                    }

                    // 5.2 Check 02:00-06:00 (Same Day) to Day (Same Day Block until 18:00)
					if (rowIndex === MORNING_SHIFT_6_10_INDEX || rowIndex === MORNING_SHIFT_10_14_INDEX || rowIndex === AFTERNOON_SHIFT_14_18_INDEX) {
						const night02_06_shift_cell = scheduleData[NIGHT_SHIFT_02_06_INDEX][colIndex];
						const nightNames = night02_06_shift_cell.split(',').map(n => n.trim()).filter(n => n.length > 0);
						
						names.forEach(currentName => {
							if (nightNames.includes(currentName.trim())) { 
								// ×¨×™×©×•× ×‘×˜×‘×œ×ª ×”×—×¨×™×’×•×ª
								exceptions.push({
									day: day,
									slot: timeSlotDisplay,
									name: currentName.trim(),
									msg: "×”×¤×¨×ª ×× ×•×—×” (18:00): ×©××¨ ×‘×œ×™×œ×” (02-06) ×•××©×•×‘×¥ ×©×•×‘ ×œ×¤× ×™ 18:00 ×‘××•×ª×• ×™×•×"
								});
								sameDayNightBlockViolation = true; 
							}
						});
					}
                    
                    // 6. **×‘×“×™×§×ª ×”×¤×¨×ª ×¨×¦×£ ×œ×™×œ×•×ª (22-02 ××ª××•×œ -> 02-06 ×”×™×•×)**
					if (rowIndex === NIGHT_SHIFT_02_06_INDEX && colIndex > 0) {
						const prevDayIndex = colIndex - 1;
						const prevNightShiftCell = scheduleData[NIGHT_SHIFT_22_2_INDEX][prevDayIndex];
						const prevNightNames = prevNightShiftCell.split(',').map(n => n.trim()).filter(n => n.length > 0);
						names.forEach(currentName => {
							if (prevNightNames.includes(currentName.trim())) { 
								// ×¨×™×©×•× ×‘×˜×‘×œ×ª ×”×—×¨×™×’×•×ª
								exceptions.push({
									day: day,
									slot: timeSlotDisplay,
									name: currentName.trim(),
									msg: "×¨×¦×£ ×œ×™×œ×•×ª ××¡×•×¨: ×©××¨ ××ª××•×œ ×‘×œ×™×œ×” (22-02) ×•××©×•×‘×¥ ×”×™×•× ×‘×œ×™×œ×” (02-06)"
								});
								consecutiveNightViolation = true; 
							}
						});
					}

                    // 7. **×‘×“×™×§×” × ×•×¡×¤×ª: ×—×¨×™×’×” ×××©××¨×ª 02:00-06:00 (××›×¡×” ×©×‘×•×¢×™×ª)**
                    let night2to6LimitExceeded = false;
                    if (isNight2to6) {
                        names.forEach(name => {
                            if ((nightShift2to6Count[name.trim()] || 0) > MAX_NIGHT_2_6) { night2to6LimitExceeded = true; }
                        });
                    }
                    

                    // --- ×§×‘×™×¢×ª ××—×œ×§×ª ×”×ª× ×•×”××–×”×¨×” ---
                    let cellClass = '';
                    let warningText = '';

                    if (numNames === 0) {
                        if (isAssistanceShift) {
                            cellClass = '';
                            warningText = '';
                        } else {
                            cellClass = 'needs-selection';
                            warningText = '<span class="warning-text">×‘×¢×™×”! ××©×‘×¦×ª ×¨×™×§×”</span>';
                        }
                    } else if (consecutiveShiftViolation) {
                        exceptions.push({
                            day: day,
                            slot: timeSlotDisplay,
                            name: names.join(', '),
                            msg: "×”×¤×¨×ª ×¨×¦×£: ×¤×—×•×ª ×-8 ×©×¢×•×ª ×× ×•×—×” ×‘×™×Ÿ ××©××¨×•×ª ×‘××•×ª×• ×™×•×"
                        });
                        // ××©××™×¨×™× class ×¨×’×™×œ ×›×“×™ ×©×œ× ×™×”×™×” ××“×•×
                        cellClass = isNightShift ? 'night-shift-ok' : 'ok-shift';
                    } else if (numNames > maxAllowedInShift && numNames > 0) {
                        cellClass = 'needs-selection'; 
                        warningText = `<span class="warning-text">âš ï¸ ×™×•×ª×¨ ××“×™ ×¢×•×‘×“×™× (${numNames}). ×“×¨×•×©×™×: ${maxAllowedInShift}</span>`;
                    } else {
                        // ××¦×‘ ×ª×§×™×Ÿ ××• ×—×¨×™×’×” ×©× ×¨×©××” ×›×‘×¨ ×‘×˜×‘×œ×” ×œ××˜×”
                        if (isAssistanceShift) {
                            cellClass = 'red-assistance-shift';
                        } else {
                            cellClass = isNightShift ? 'night-shift-ok' : 'ok-shift';
                        }
                    }

                    const formattedNames = names.map(name => {
                        const key = name.includes(' ') ? name.trim().replace(' ', '_') : name.trim();
                        const className = colorMap[key] || 'person';
                        return `<span class="person ${className}" title="${name} - ${day}, ${timeSlotDisplay}">${name}</span>`;
                    }).join('');

					// ×‘×“×™×§×” ×”×× ×–×• ××©××¨×ª ×œ×™×•×•×™ ×•×’× ×™×•× ×©×‘×ª
					const isSaturdayAssistance = isAssistanceShift && day.includes('×©×‘×ª');
					// ×”×•×¡×¤× ×• ××ª ×”-class "waving-flag" ×•×”×’×“×œ× ×• ××ª ×”×¤×•× ×˜ ××©××¢×•×ª×™×ª ×œ-3em
					const flag = isSaturdayAssistance ? '<span class="waving-flag" style="font-size: 3em; margin-left: 15px;">ğŸ‡®ğŸ‡±</span>' : '';

					scheduleTableHTML += `<td data-day="${day}" data-time="${timeSlotDisplay}" class="${cellClass}">
						${flag}${formattedNames} ${warningText}
					</td>`;
                });
                scheduleTableHTML += '</tr>';
            });
            scheduleTableHTML += '</tbody></table>';
            
            // **2. ×©××™×¨×ª ×”-HTML ×©×œ ×”×˜×‘×œ×” ×œ××©×ª× ×” ×’×œ×•×‘×œ×™**
            lastRenderedTableHTML = scheduleTableHTML;Â 
            
            // **3. ×”××©×š ×™×¦×™×¨×ª ×˜×‘×œ×ª ×”×¡×™×›×•× ×•×”×¦×’×”**
            tableHTML += scheduleTableHTML + '<hr>';
            
//////////////////////////////////////////////////////////////////////////////////////////////
            
            // ×™×¦×™×¨×ª ×˜×‘×œ×ª ×”×¡×™×›×•×
            let summaryTableHTML = `<h3>×¡×™×›×•× ×ª×“×™×¨×•×ª ×”×•×¤×¢×” ×©×œ ×›×œ ×¢×•×‘×“ (××™× ×™××•×: ${MIN_REQUIRED}, ××§×¡×™××•×: ${MAX_ALLOWED}) - ×œ×œ× ××©××¨×•×ª ×œ×™×•×•×™</h3>`;Â 
            summaryTableHTML += `
                <table id="summary-table">
                    <thead>
                        <tr>
                            <th>××¡'</th>
                            <th>×©× ×”×¢×•×‘×“</th>
                            <th>×¡×š ×”×•×¤×¢×•×ª</th>
                            <th>××©××¨×•×ª 02-06 (×”×’×‘×œ×”: ${MAX_NIGHT_2_6})</th>Â 
                            <th>×¢××™×“×” ×‘×ª× ××™ (${MIN_REQUIRED}-${MAX_ALLOWED})</th>
                        </tr>
                    </thead>
                    <tbody id="summary-body">`;
            
            const sortedNames = Object.keys(allShifts).sort((a, b) => {
				const countA = allShifts[a];
				const countB = allShifts[b];

				// ×× ×›××•×ª ×”××©××¨×•×ª ×©×•× ×”, ×©×™× ××ª ×”×’×‘×•×”×” ×™×•×ª×¨ ×œ××¢×œ×”
				if (countB !== countA) {
					return countB - countA; // ×”×’×‘×•×” ×‘×™×•×ª×¨ (5) ×™×”×™×” ×¨××©×•×Ÿ
				}

				// ×× ×”×›××•×ª ×©×•×•×”, ××™×™×Ÿ ×œ×¤×™ ×¡×“×¨ ×”××•×ª×™×•×ª (×›×“×™ ×©×™×”×™×” ××¡×•×“×¨)
				return a.localeCompare(b, 'he');
			});
            let counter = 1;
            sortedNames.forEach(name => {
                const count = allShifts[name];
                const night2to6Count = nightShift2to6Count[name] || 0; // **×”×•×¡×¤×”: ×¡×¤×™×¨×ª ×œ×™×œ×•×ª 02-06**
                
                let rowClass = '';
                let statusText = '';
                let night2to6Status = night2to6Count > MAX_NIGHT_2_6 ?Â 
                    `<span class="night-limit-fail">âŒ ${night2to6Count}</span>` :Â 
                    `<span class="night-limit-ok">âœ… ${night2to6Count}</span>`;


				// ×‘×“×™×§×ª ×¢××™×“×” ×‘×ª× ××™ ×”×—×“×© (3 ×¢×“ 5 ××©××¨×•×ª)
			if (count === 5) {
					rowClass = 'shifts-5-count'; // ×›×—×•×œ
					statusText = `âœ… ×¢××“ (5 ××©××¨×•×ª - ××§×¡×™××•×)`;
				} else if (count === 4) {
					rowClass = 'shifts-4-count'; // ×™×¨×•×§ ×›×”×”
					statusText = `âœ… ×¢××“ (4 ××©××¨×•×ª)`;
				} else if (count < MIN_REQUIRED) {
					rowClass = 'low-shifts'; // ××“×•×
					statusText = `âŒ ×œ× ×¢××“ (×¤×—×•×ª ×-${MIN_REQUIRED} - ${count})`;
				} else { 
					rowClass = 'not-met-condition';
					statusText = `âŒ ××™×¡×•×¨! (×™×•×ª×¨ ××“×™ - ${count})`;
					
					exceptions.push({
						day: "×¡×™×›×•× ×©×‘×•×¢×™",
						slot: "××›×¡×ª ××©××¨×•×ª",
						name: name,
						msg: `×—×¨×™×’×”: ${count} ××©××¨×•×ª (×”××§×¡×™××•× ×”××•×ª×¨ ×”×•× 5)`
					});
				}
				
                // ×”×•×¡×¤×ª ×§×œ××¡ ×”×ª×¨××” ×’× ×× ×—×¨×’×• ×××©××¨×ª ×”×œ×™×œ×” ×”×¡×¤×¦×™×¤×™×ª
                if (night2to6Count > MAX_NIGHT_2_6) {
                    rowClass += ' night-limit-fail-row';
                }

                summaryTableHTML += `
                    <tr class="${rowClass}">
                        <td style="text-align: center;">${counter++}</td>
                        <td>${name}</td>
                        <td style="text-align: center;">${count}</td>
                        <td style="text-align: center;">${night2to6Status}</td>Â 
                        <td style="text-align: center;">${statusText}</td>
                    </tr>
                `;
            });

            summaryTableHTML += '</tbody></table>';
            
			
		// --- ×‘× ×™×™×ª ×˜×‘×œ×ª ×”×—×¨×™×’×•×ª (××¢×œ ×”×¡×™×›×•×) ---
		let exceptionsTableHTML = `
			<div style="text-align: center; margin-top: 20px;">
				<h3 id="exceptions-header">âš ï¸ ×¨×™×›×•×– ×—×¨×™×’×•×ª ×•××–×”×¨×•×ª</h3>
			</div>
			<table id="exceptions-table">
				<thead>
					<tr>
						<th>×™×•×</th>
						<th>××©××¨×ª</th>
						<th>×¢×•×‘×“</th>
						<th>×¤×™×¨×•×˜ ×”×—×¨×™×’×”</th>
					</tr>
				</thead>
				<tbody>`;

		if (exceptions.length === 0) {
			exceptionsTableHTML += `<tr><td colspan="4">××™×Ÿ ×—×¨×™×’×•×ª ×‘×¡×™×“×•×¨! âœ…</td></tr>`;
		} else {
			exceptions.forEach(ex => {
				exceptionsTableHTML += `<tr>
					<td>${ex.day}</td>
					<td>${ex.slot}</td>
					<td><b>${ex.name}</b></td>
					<td>${ex.msg}</td>
				</tr>`;
			});
		}
		exceptionsTableHTML += `</tbody></table><hr>`;

		// --- ×”×—×™×‘×•×¨ ×”×¡×•×¤×™ ×œ×¤×™ ×”×¡×“×¨ ×”××‘×•×§×© ---
		// ×§×•×“× ×›×œ ×”×˜×‘×œ×” ×”×¨××©×™×ª ×©×›×‘×¨ × ××¦××ª ×‘×ª×•×š tableHTML
		// ×¢×›×©×™×• ××•×¡×™×¤×™× ××ª ×”×—×¨×™×’×•×ª, ×•×¨×§ ××– ××ª ×”×¡×™×›×•×
		tableHTML += exceptionsTableHTML + summaryTableHTML;

		// ×”×¦×’×ª ×”×ª×•×¦××” ×”×¡×•×¤×™×ª ×‘××¡×š
		resultsContainer.innerHTML = tableHTML;
        }


        /**
         * ×¤×•× ×§×¦×™×” ××¢×•×“×›× ×ª ×œ×”×•×¨×“×ª ×§×•×‘×¥ HTML ×©××›×™×œ ×¨×§ ××ª ×”×˜×‘×œ×” ×”××¢×•×¦×‘×ª - ×›×•×œ×œ ×ª××¨×™×›×™×
         */
		function downloadHtmlTable() {
			const startDateString = document.getElementById('startDate').value;
			const resultsHTML = document.getElementById('results-container').innerHTML;

			if (!startDateString || !resultsHTML || resultsHTML.includes('×”×˜×¢×™× ×” ×”×¨××©×•× ×™×ª')) {
				alert('×™×© ×œ×‘×—×•×¨ ×ª××¨×™×š ×•×œ×‘×¦×¢ × ×™×ª×•×— × ×ª×•× ×™× ×œ×¤× ×™ ×”×”×•×¨×“×”!');
				return;
			}
		
			// --- ×—×™×©×•×‘ ×ª××¨×™×›×™ ×”×©×‘×•×¢ ×œ×›×•×ª×¨×ª ---
            const [year, month, day] = startDateString.split('-');
            const dateSun = new Date(year, month - 1, day);
            const dateSat = new Date(dateSun);
            dateSat.setDate(dateSun.getDate() + 6); // ××•×¡×™×£ 6 ×™××™× ×›×“×™ ×œ×”×’×™×¢ ×œ×©×‘×ª
			
			const format = (d) => `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}`;
			const dynamicHeader = `×˜×‘×œ×ª ××©××¨×•×ª ×©×‘×•×¢×™×ª ${format(dateSun)} - ${format(dateSat)}`;
			
            const datesForWeek = getDatesForWeek(startDateString);
            const style = document.querySelector('style').textContent;

            // ×›××Ÿ ×× ×—× ×• ××•×¡×™×¤×™× ××ª ×”×§×•×“ ×©×™×•×¤×™×¢ ×‘×ª×•×š ×”×§×•×‘×¥ ×©× ×©×œ×— ×‘×•×•××˜×¡××¤
            const highlightScript = `
                document.addEventListener('mouseover', function (e) {
                    if (e.target.classList.contains('person')) {
                        const name = e.target.textContent.trim();
                        document.querySelectorAll('.person').forEach(el => {
                            if (el.textContent.trim() === name) el.classList.add('highlight-name');
                        });
                    }
                });
                document.addEventListener('mouseout', function (e) {
                    if (e.target.classList.contains('person')) {
                        document.querySelectorAll('.person').forEach(el => el.classList.remove('highlight-name'));
                    }
                });
                // ×ª××™×›×” ×‘×˜×œ×¤×•× ×™× × ×™×™×“×™× - ×œ×—×™×¦×” ××“×œ×™×§×”/××›×‘×” ××ª ×”×¡×™××•×Ÿ
                document.addEventListener('click', function (e) {
                    if (e.target.classList.contains('person')) {
                        const name = e.target.textContent.trim();
                        const isHighlighted = e.target.classList.contains('highlight-name');
                        document.querySelectorAll('.person').forEach(el => el.classList.remove('highlight-name'));
                        if (!isHighlighted) {
                            document.querySelectorAll('.person').forEach(el => {
                                if (el.textContent.trim() === name) el.classList.add('highlight-name');
                            });
                        }
                    } else {
                        document.querySelectorAll('.person').forEach(el => el.classList.remove('highlight-name'));
                    }
                });
            `;

            const cleanHTMLContent = `
                <!DOCTYPE html>
                <html lang="he" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>${dynamicHeader}</title>
                    <style>
                        ${style}
                        body { padding: 20px; text-align: center; }
                    </style>
                </head>
                <body>
                    <h1 class="modern-main-header">${dynamicHeader}</h1>
                    <div id="results-container">${lastRenderedTableHTML}</div>
                    <script>${highlightScript}<\/script>
                </body>
                </html>
            `;
            
            const bom = '\ufeff'; 
            const blob = new Blob([bom + cleanHTMLContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
			link.href = url;
			link.download = `sidur_${startDateString}.html`;
			document.body.appendChild(link);
			link.click();
			document.body.removeChild(link);
			URL.revokeObjectURL(url);
        }

        // ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×¡×™×“×•×¨ ××•×˜×•××˜×™ ×©×œ ×”××©××¨×•×ª - ×¢× ××™×œ×•×¦×™× ××¢×•×“×›× ×™×
        function autoSchedule() {
			const guardsFor5Text = document.getElementById('guardsFor5Shifts').value;
			const guardsFor5Set = new Set(guardsFor5Text.split(/[,\n]/).map(name => name.trim()).filter(name => name !== ''));
            const textContent = document.getElementById('dataToAnalyze').value;
            const startDateString = document.getElementById('startDate').value;

            if (!startDateString) {
                alert('×× × ×‘×—×¨ ×ª××¨×™×š ×”×ª×—×œ×” (×™×•× ×¨××©×•×Ÿ) ×œ×¤× ×™ ×”×¡×™×“×•×¨ ×”××•×˜×•××˜×™.');
                return;
            }
			
			// ×”××©×ª× ×” ××•×’×“×¨ ×›×¡×˜ ×¨×™×§ ×›×“×™ ×œ×× ×•×¢ ×©×’×™××•×ª ×‘×”××©×š ×”×§×•×“.
Â  Â  Â  Â  Â  Â  const excludedGuardsSet = new Set();

            const initialParsedData = parseVerticalText(textContent);

            if (initialParsedData.error) {
                document.getElementById('results-container').innerHTML = `<p class="warning-text">âŒ ×©×’×™××” ×‘× ×™×ª×•×— × ×ª×•× ×™× ×§×™×™××™×. ×™×© ×œ×ª×§×Ÿ ××ª × ×ª×•× ×™ ×”×§×œ×˜ ×œ×¤× ×™ ×”×¡×™×“×•×¨ ×”××•×˜×•××˜×™.</p>`;
                return;
            }

            const allEmployees = Object.keys(colorMap).map(key => key.includes('_') ? key.replace('_', ' ') : key);
            let employeeShiftsCount = {}; 
            let nightShift2to6Count = {};Â 
            let newScheduleData = initialParsedData.data.map(row => row.map(cell => [])); 
            let nightToMorningCheck = initialParsedData.days.map(() => new Set()); 
            let dailyOccupancy = initialParsedData.days.map(() => new Set()); 
            let daily8HourBreakRequired = initialParsedData.days.map(() => new Set()); 
            let availabilityMap = {}; 
            
            // --- ×œ×•×œ××ª ×”××™×˜×¨×¦×™×” ×”×¨××©×™×ª ---
            for (let iteration = 0; iteration < MAX_ITERATIONS; iteration++) {
                
                // 1. ××™×¤×•×¡ ×¡×¤×™×¨×•×ª ×•××›×™×¤×” (×‘×›×œ ××™×˜×¨×¦×™×”, × ×‘× ×” ××—×“×© ××ª ×”×˜×‘×œ×” ×¢×œ ×‘×¡×™×¡ × ×ª×•× ×™ ×”×–××™× ×•×ª)
                allEmployees.forEach(name => {
                    employeeShiftsCount[name] = 0;
                    nightShift2to6Count[name] = 0;
                });
                
                // ××™×¤×•×¡ ×¡×˜×™× ×™×•××™×™×
                nightToMorningCheck = initialParsedData.days.map(() => new Set());Â 
                dailyOccupancy = initialParsedData.days.map(() => new Set()); 
                daily8HourBreakRequired = initialParsedData.days.map(() => new Set()); 
                availabilityMap = {};
                
                // ×¡×˜×™ ×”×—×¡×™××•×ª ×”×—×“×©×™× (× ×‘× ×™× ××—×“×© ×‘×›×œ ××™×˜×¨×¦×™×” ×¢×œ ×‘×¡×™×¡ newScheduleData)
                let night22_02_block = initialParsedData.days.map(() => new Set()); 
                let night02_06_block = initialParsedData.days.map(() => new Set()); 

                const shiftsToFill = []; // ×”××©×‘×¦×•×ª ×©×¦×¨×™×š ×œ××œ× ×‘××™×˜×¨×¦×™×” ×–×•
				let assistanceShiftsDone = new Set(); // **×—×“×©: ××¢×§×‘ ××—×¨×™ ××©××¨×•×ª ×œ×™×•×•×™**


                // 2. ××™×¡×•×£ × ×ª×•× ×™ ×–××™× ×•×ª ×•×”×¢×ª×§×ª ×©×™×‘×•×¥ ×™×“× ×™
                let mustStop = false;

                initialParsedData.data.forEach((row, shiftIndex) => {
                    const timeSlotFull = EXPECTED_TIME_SLOTS[shiftIndex];
                    const isAssistanceShift = timeSlotFull.includes('(Assist)');
                    const isNightShift = timeSlotFull.includes('(Night)');
                    const isNight2to6 = shiftIndex === NIGHT_SHIFT_2_6_INDEX; 
                    const required = isNightShift ? 2 : 1;
                    
                    row.forEach((cellContent, dayIndex) => {
                        const availableNames = cellContent.split(',').filter(name => name.trim().length > 0);
                        
                        if (!availabilityMap[dayIndex]) availabilityMap[dayIndex] = {};
                        availabilityMap[dayIndex][shiftIndex] = new Set(availableNames);

						// ×©×™×‘×•×¥ ×™×“× ×™ (×× ×”×•×›× ×¡×•) ×•×¡×¤×™×¨×ª × ×ª×•× ×™×
						// *** ×§×•×“ ××ª×•×§×Ÿ: ××¤×¨×™×“ ×‘×™×Ÿ ×œ×™×•×•×™ (×©× ×©××¨ ×™×“× ×™×ª) ×œ××©××¨×•×ª ×¨×’×™×œ×•×ª ***
						let namesInSlot = []; 

						if (iteration === 0) {

						if (isAssistanceShift) {
							// ×©×•××¨×™× ××ª ××™ ×©×©×•×‘×¥ ×™×“× ×™×ª ×‘×œ×™×•×•×™ ×›×“×™ ×©×”×¨×•×‘×•×˜ ×™×“×¢ ×©×”× ×ª×¤×•×¡×™× ×•×œ× ×™×©×‘×¥ ××•×ª× ×©×•×‘ ×‘××•×ª×• ×™×•×
							namesInSlot = availableNames.filter(name => allEmployees.includes(name)); 
						} else {
								// ğŸ›‘ ×¢×‘×•×¨ ××©××¨×•×ª ×¨×’×™×œ×•×ª: ×©×•××¨×™× ×©×™×‘×•×¥ ×™×“× ×™ ×¨×§ ×× ×”×›××•×ª ×ª×§×™× ×”
								if (availableNames.length === required && availableNames.length > 0) {
									namesInSlot = availableNames; // ×©×•××¨ ×©×™×‘×•×¥ ×™×“× ×™ ×ª×§×™×Ÿ
								} else {
									namesInSlot = []; // ×× ×§×” ××©×‘×¦×ª ×¨×™×§×” ××• ×œ× ×ª×§×™× ×”
								}
							}
							// ×©××™×¨×ª ×”× ×ª×•× ×™× ×”×××•××ª×™×/×©× ×©××¨×• ×™×“× ×™×ª ×¢×‘×•×¨ ××™×˜×¨×¦×™×•×ª ×”×‘××•×ª
							newScheduleData[shiftIndex][dayIndex] = namesInSlot; 
						} else {
							// ×¢×‘×•×¨ ××™×˜×¨×¦×™×•×ª ×¢×ª×™×“×™×•×ª: ××©×ª××©×™× ×‘×©×™×‘×•×¥ ×©×›×‘×¨ × ×§×‘×¢
							namesInSlot = newScheduleData[shiftIndex][dayIndex];
						}

                        namesInSlot.forEach(name => {
                            if (allEmployees.includes(name)) {
								// ×¡×•×¤×¨ ××ª ×›×œ ×”××©××¨×•×ª, ×›×•×œ×œ ×œ×™×•×•×™
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isAssistanceShift) {
									employeeShiftsCount[name] = (employeeShiftsCount[name] || 0) + 1;
								}

								// **×—×“×©: ×”×•×¡×¤×ª ×‘×“×™×§×” ×•×¨×™×©×•× ×œ×™×•×•×™ ×™×“× ×™**
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isAssistanceShift) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  assistanceShiftsDone.add(name);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

                                if (isNight2to6) { nightShift2to6Count[name] = (nightShift2to6Count[name] || 0) + 1; }
                                dailyOccupancy[dayIndex].add(name);
                                
                                // ××¢×§×‘ ×œ×™×œ×” 22-02 (×œ×¦×•×¨×š ×—×¡×™××•×ª ×™×•× ×œ××—×¨×ª ×•×¨×¦×£ ×œ×™×œ×•×ª)
                                if (shiftIndex === NIGHT_SHIFT_22_2_INDEX) { 
                                    nightToMorningCheck[dayIndex].add(name);
                                    if (dayIndex + 1 < initialParsedData.days.length) {
                                        night22_02_block[dayIndex + 1].add(name);
                                    }
                                } 
                                
                                // ××¢×§×‘ ×œ×™×œ×” 02-06 (×œ×¦×•×¨×š ×—×¡×™××” ×¢×“ 18:00 ×‘××•×ª×• ×™×•×)
                                if (shiftIndex === NIGHT_SHIFT_02_06_INDEX) {
                                    night02_06_block[dayIndex].add(name); 
                                }

                                const nextShiftIndex = shiftIndex + 1;
                                if (CONSECUTIVE_SHIFT_CHECK[nextShiftIndex] === shiftIndex) {
                                    daily8HourBreakRequired[dayIndex].add(name);
                                }
                            }
                        });


						// ×”×¨×•×‘×•×˜ ×™××œ× ××©××¨×ª ×¨×§ ×× ×”×™× ×œ× ××©××¨×ª ×œ×™×•×•×™ (Assist) ×•×”×™× ×œ× ××œ××”
						if (!isAssistanceShift && newScheduleData[shiftIndex][dayIndex].length < required) {
							shiftsToFill.push({ 
								dayIndex, 
								shiftIndex, 
								requiredCount: required - newScheduleData[shiftIndex][dayIndex].length 
							});
						}
                    });
                    if (mustStop) return;
                });
                if (mustStop) return;


                // 3. ××™×•×Ÿ ×”××©××¨×•×ª ×œ××™×œ×•×™ ××•×˜×•××˜×™ (×›×¨×•× ×•×œ×•×’×™: ×™×•× ××—×¨×™ ×™×•×, ××©××¨×ª ××—×¨×™ ××©××¨×ª)
                shiftsToFill.sort((a, b) => {
                    if (a.dayIndex !== b.dayIndex) return a.dayIndex - b.dayIndex;
                    return a.shiftIndex - b.shiftIndex;
                });
                
                let shiftsFilledThisIteration = 0;
                
                // 4. ×¤×•× ×§×¦×™×™×ª × ×™×§×•×“ ××•×¨×›×‘×ª
// ×‘×ª×•×š ×¤×•× ×§×¦×™×™×ª autoSchedule, ×ª×—×ª ×¤×•× ×§×¦×™×™×ª scoreEmployee:

				function scoreEmployee(name, count, dayIndex, shiftIndex) {
					let score = 0;
					
					// ×”×’×“×¨×ª ×™×¢×“ ××™×©×™
					let personalTarget = guardsFor5Set.has(name) ? 5 : MIN_REQUIRED;

					// 1. ×¢×“×™×¤×•×ª ×§×¨×™×˜×™×ª ×œ××™ ×©×˜×¨× ×”×’×™×¢ ×œ×™×¢×“ ×©×œ×• (×•×‘××™×•×—×“ ×œ××œ×• ×©×œ 5 ××©××¨×•×ª)
					if (count < personalTarget) {
						// ×‘×•× ×•×¡ ××©××¢×•×ª×™ ×©××‘×˜×™×— ×©×”× ×™×™×‘×—×¨×• ×œ×¤× ×™ ××—×¨×™×
						score += 5000 * (personalTarget - count); 
					}

					// 2. ×¢×“×™×¤×•×ª ××©× ×™×ª ×œ××™ ×©×©××¨ ×¤×—×•×ª ×‘××•×¤×Ÿ ×›×œ×œ×™ (×œ××™×–×•×Ÿ)
					score += (MAX_ALLOWED - count) * 10;

					// --- ×—×¡×™××•×ª ×§×¨×™×˜×™×•×ª (×¢×•× ×©×™× ×›×‘×“×™× ×××•×“ - ××•× ×¢×™× ×©×™×‘×•×¥ ×œ× ×—×•×§×™) ---
					
					// ×—×¡×™××ª ×›×¤×™×œ×•×ª ×™×•××™×ª ××• ×”×¤×¨×ª ×× ×•×—×ª 8 ×©×¢×•×ª (×—×•×‘×”!)
					if (dailyOccupancy[dayIndex].has(name) || daily8HourBreakRequired[dayIndex].has(name)) {
						return -1000000; 
					}
					
					// ×—×¡×™××•×ª ×× ×•×—×ª ×œ×™×œ×” (×”×—×•×§×™× ×”×§×©×™×—×™× ×©×œ×š)
					if (night22_02_block[dayIndex].has(name) && (shiftIndex === MORNING_SHIFT_6_10_INDEX || shiftIndex === MORNING_SHIFT_10_14_INDEX)) {
						 return -2000000;
					}
					if (night02_06_block[dayIndex].has(name) && (shiftIndex <= AFTERNOON_SHIFT_14_18_INDEX)) {
						 return -2000000;
					}

					// ×”×’×‘×œ×ª ××›×¡×ª ××§×¡×™××•× ××‘×¡×•×œ×•×˜×™×ª (5)
					if (count >= MAX_ALLOWED) {
						return -500000;
					}

					return score;
				}

                // 5. ××™×œ×•×™ ×”××©××¨×•×ª ×”×—×¡×¨×•×ª
                // --- ××™×œ×•×™ ×”××©××¨×•×ª ×”×—×¡×¨×•×ª (×œ×•×’×™×§×” ××¢×•×“×›× ×ª ×‘×©× ×™ ×¡×‘×‘×™×) ---

                // ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×¤× ×™××™×ª ×œ×‘×™×¦×•×¢ ×”×©×™×‘×•×¥ ×‘×¤×•×¢×œ
                function fillShiftLogic(shift, onlyGuardsFor5) {
                    const { dayIndex, shiftIndex, requiredCount } = shift;
                    const isNightShift = EXPECTED_TIME_SLOTS[shiftIndex].includes('(Night)');
                    const maxInShift = isNightShift ? 2 : 1;
                    
                    // ×× ×”××©××¨×ª ×›×‘×¨ ×”×ª××œ××” ×‘×¡×‘×‘ ×”×§×•×“×, ×“×œ×’
                    if (newScheduleData[shiftIndex][dayIndex].length >= maxInShift) {
                        return;
                    }

                    const availableInSlot = Array.from(availabilityMap[dayIndex][shiftIndex]);
                    const alreadyAssigned = new Set(newScheduleData[shiftIndex][dayIndex]);
                    
                    // ×¡×™× ×•×Ÿ ××•×¢××“×™× ×œ×¤×™ ×”×¡×‘×‘ ×”× ×•×›×—×™
                    let filteredCandidates = availableInSlot.filter(name => !alreadyAssigned.has(name));
                    
                    if (onlyGuardsFor5) {
                        // ×‘×¡×‘×‘ ×”×¨××©×•×Ÿ, ××©××™×¨×™× ×¨×§ ××ª ×”×©×•××¨×™× ×©×¡×•×× ×• ×‘×¦×”×•×‘
                        filteredCandidates = filteredCandidates.filter(name => guardsFor5Set.has(name));
                    }

                    let needed = maxInShift - newScheduleData[shiftIndex][dayIndex].length;
                    
                    while (needed > 0 && filteredCandidates.length > 0) {
                        const scoredCandidates = filteredCandidates.map(name => {
                            const currentCount = employeeShiftsCount[name] || 0;
                            const score = scoreEmployee(name, currentCount, dayIndex, shiftIndex);
                            return { name, score };
                        });

                        scoredCandidates.sort((a, b) => b.score - a.score);
                        const bestCandidate = scoredCandidates[0];

                        // ×‘×“×™×§×” ×©×”××•×¢××“ ×—×•×§×™ (×œ× ××¤×¨ ×—×•×§×™ ×× ×•×—×” ×§×©×™×)
                        if (bestCandidate && bestCandidate.score > -90000) {
                            const name = bestCandidate.name;
                            newScheduleData[shiftIndex][dayIndex].push(name);
                            employeeShiftsCount[name]++;
                            dailyOccupancy[dayIndex].add(name);
                            
                            // ×¢×“×›×•×Ÿ ××¢×§×‘ ×—×¡×™××•×ª
                            if (shiftIndex === NIGHT_SHIFT_2_6_INDEX) {
                                nightShift2to6Count[name] = (nightShift2to6Count[name] || 0) + 1;
                                night02_06_block[dayIndex].add(name);
                            }
                            if (shiftIndex === NIGHT_SHIFT_22_2_INDEX) {
                                nightToMorningCheck[dayIndex].add(name);
                                if (dayIndex + 1 < initialParsedData.days.length) {
                                    night22_02_block[dayIndex + 1].add(name);
                                }
                            }

                            const nextShiftIndex = shiftIndex + 1;
                            if (CONSECUTIVE_SHIFT_CHECK[nextShiftIndex] === shiftIndex) {
                                daily8HourBreakRequired[dayIndex].add(name);
                            }

                            filteredCandidates = filteredCandidates.filter(n => n !== name);
                            needed--;
                        } else {
                            break;
                        }
                    }
                }

                // ×”×¨×¦×ª ×¡×‘×‘ 1: ×¢×“×™×¤×•×ª ××•×—×œ×˜×ª ×œ×©×•××¨×™× ×©×—×™×™×‘×™× 5 ××©××¨×•×ª
                shiftsToFill.forEach(shift => fillShiftLogic(shift, true));

                // ×”×¨×¦×ª ×¡×‘×‘ 2: ××™×œ×•×™ ×©××¨ ×”××©×‘×¦×•×ª ×¢× ×©××¨ ×”×¢×•×‘×“×™×
                shiftsToFill.forEach(shift => fillShiftLogic(shift, false));

                // 6. ×‘×“×™×§×ª ×ª× ××™ ×¢×¦×™×¨×” - ×”×× ×›×•×œ× ×¢××“×• ×‘××™× ×™××•×?
                const employeesBelowMin = allEmployees.filter(name => employeeShiftsCount[name] < MIN_REQUIRED);
                const unfilledShifts = shiftsToFill.length;
                
                if (unfilledShifts === 0 && employeesBelowMin.length === 0) {
                    break;
                }
                
                if (iteration === MAX_ITERATIONS - 1) {
                    console.warn("MAX ITERATIONS REACHED. CHECKING FINAL RESULTS.");
                    break;
                }
            } // --- ×¡×•×£ ×œ×•×œ××ª ×”××™×˜×¨×¦×™×” ×”×¨××©×™×ª ---
            
            // **×©×œ×‘ 4: ×‘× ×™×™×ª ×˜×§×¡×˜ ×”×§×œ×˜ ××—×“×© ×•×”×¦×’×” (×œ××—×¨ ×”××™×˜×¨×¦×™×•×ª)**
            let newText = '';
            
            initialParsedData.days.forEach((day, dayIndex) => {
                newText += `${day}\n`;
                newScheduleData.forEach((row, shiftIndex) => {
                    const timeSlotFull = EXPECTED_TIME_SLOTS[shiftIndex];
                    const timeSlotDisplay = timeSlotFull.split('(')[0].trim();
                    const namesAssigned = row[dayIndex];
                    const namesString = namesAssigned.join('\t');
                    newText += `${timeSlotDisplay}\t${namesString}\n`;
                });
                newText += '\n'; 
            });

            document.getElementById('dataToAnalyze').value = newText.trim();
            const finalParsedData = parseVerticalText(newText.trim());
            renderSchedule(finalParsedData);

            // ×¡×™×›×•× ×¡×˜×˜×•×¡
            const finalCounts = allEmployees.map(name => ({ name, count: employeeShiftsCount[name] }));
            const finalBelowMin = finalCounts.filter(e => e.count < MIN_REQUIRED);
            const msg = document.getElementById('link-message');

            if (finalBelowMin.length === 0) {
                msg.querySelector('p').textContent = `âœ… ×¡×™×“×•×¨ ××•×˜×•××˜×™ ×”×¡×ª×™×™× ×‘×”×¦×œ×—×”! ×›×•×œ× ××©×•×‘×¦×™× ×‘××™× ×™××•× ${MIN_REQUIRED}.`;
                msg.style.backgroundColor = '#4CAF50';
            } else {
                const namesList = finalBelowMin.map(e => `${e.name} (${e.count})`).join(', ');
                msg.querySelector('p').textContent = `âš ï¸ ×¡×™×“×•×¨ ×”×¡×ª×™×™×. ${finalBelowMin.length} ×¢×•×‘×“×™× ×¢×“×™×™×Ÿ ××ª×—×ª ×œ××™× ×™××•× ${MIN_REQUIRED}: ${namesList}. × ×“×¨×©×ª ×”×©×œ××” ×™×“× ×™×ª/×‘×“×™×§×ª ×–××™× ×•×ª.`;
                msg.style.backgroundColor = '#ff9800'; // ×›×ª×•× ×œ××–×”×¨×”
            }

            msg.style.display = 'block';
            setTimeout(() => {
                msg.style.display = 'none';
            }, 8000);
        }


		
		// --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×•×§×™×©×•×¨×™ ×›×¤×ª×•×¨×™× (× ×©××¨×•×ª ×›×¤×™ ×©×”×Ÿ) ---
        
        function aggressiveClean(line) { return line.replace(/[\u0000-\u001F\u007F-\u009F\uFEFF\u00A0]/g, '').trim(); }
        
						/**
		 * ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×”×•×¨×“×ª × ×ª×•× ×™ ×”×§×œ×˜ (××• ×”×¤×œ×˜ ×”××©×•×‘×¥) ×›×§×•×‘×¥ CSV
		 */
	/**
	 * ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×”×•×¨×“×ª ×”× ×ª×•× ×™× ×”×× ×•×ª×—×™× (×˜×‘×œ×ª ×”××©××¨×•×ª ×”×¡×•×¤×™×ª) ×›×§×•×‘×¥ CSV.
	 * ×›×•×œ×œ ×ª×™×§×•×Ÿ "sep=\t" ×œ×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª ×™×™×©×•×¨ ×‘××§×¡×œ (××•×¤×™×¡/×¢×‘×¨×™×ª).
	 */
			function downloadCsvFile() {
			const textContent = document.getElementById('dataToAnalyze').value;
			const startDateString = document.getElementById('startDate').value;
			const parsedData = parseVerticalText(textContent); // ×× ×ª×— ××ª ×”× ×ª×•× ×™× ×”× ×•×›×—×™×™×

			if (parsedData.error || !textContent.trim()) {
				alert('âŒ ×œ× × ××¦××• × ×ª×•× ×™× ×ª×§×™× ×™× ××• ×©××™×Ÿ × ×ª×•× ×™× ×›×œ×œ. × ×ª×—/×¡×“×¨ ××•×˜×•××˜×™ ×ª×—×™×œ×”.');
				return;
			}

			const { days: dayHeaders, data: scheduleData } = parsedData;
			// **×—×“×©: ×§×¨×™××ª ×™××™× ×©×‘×”× ×”×œ×™×•×•×™ ××‘×•×˜×œ (×œ×¦×•×¨×š ×ª×¦×•×’×”)**
Â  Â  Â  Â  Â  Â  const holidaySet = new Set();
Â  Â  Â  Â  Â  Â  const holidayCheckboxes = document.querySelectorAll('#holidayChecklist input[type="checkbox"]:checked');
Â  Â  Â  Â  Â  Â  holidayCheckboxes.forEach(cb => {
Â  Â  Â  Â  Â  Â  Â  Â  holidaySet.add(parseInt(cb.value, 10)); // cb.value ×”×•× ××™× ×“×§×¡ ×”×™×•× (0-6)
Â  Â  Â  Â  Â  Â  });
			const datesForWeek = getDatesForWeek(startDateString);
			
			// ×™×¦×™×¨×ª ×›×•×ª×¨×ª ×”-CSV: ×©×¢×•×ª | ×™×•× ×' (×ª××¨×™×š) | ×™×•× ×‘' (×ª××¨×™×š) | ...
			let csvHeaders = ['×©×¢×•×ª / ×™×•×'];
			dayHeaders.forEach((day, index) => {
				csvHeaders.push(`${day} (${datesForWeek[index]})`);
			});
			
			// *** ×–×”×• ×”×ª×™×§×•×Ÿ ×”×¢×™×§×¨×™ - ×”×•×¡×¤×ª "sep=\t" ×œ×˜×•×‘×ª ××§×¡×œ ***
			let csvContent = "sep=\t\n" + csvHeaders.join('\t') + '\n';
			
			// ×™×¦×™×¨×ª ×©×•×¨×•×ª ×”× ×ª×•× ×™×
			scheduleData.forEach((row, rowIndex) => {
				const timeSlotFull = EXPECTED_TIME_SLOTS[rowIndex];
				const timeSlotDisplay = timeSlotFull.split('(')[0].trim();
				
				let csvRow = [timeSlotDisplay];
				
				row.forEach(cellContent => {
					// ×”×•×¤×š ××ª ×”× ×ª×•× ×™× ×”××©×•×‘×¦×™× ×œ××—×¨×•×–×ª ××—×ª ××•×¤×¨×“×ª ×‘×¤×¡×™×§×™×
					const names = cellContent.split(',').filter(name => name.trim().length > 0);
					csvRow.push(names.join(', '));
				});
				
				csvContent += csvRow.join('\t') + '\n';
			});

			const bom = '\ufeff'; // ×”×•×¡×¤×ª BOM ×œ×˜×™×¤×•×œ × ×›×•×Ÿ ×‘×¢×‘×¨×™×ª
			const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
			const url = URL.createObjectURL(blob);
			const link = document.createElement('a');

			link.href = url;
			link.download = `schedule_table_analyzed_${startDateString}.csv`;
			document.body.appendChild(link);
			link.click();
			document.body.removeChild(link);

			URL.revokeObjectURL(url);
			
			const msg = document.getElementById('link-message');
			msg.querySelector('p').textContent = 'âœ… ×§×•×‘×¥ CSV ×× ×•×ª×— ×”×•×¨×“ ×‘×”×¦×œ×—×”!';
			msg.style.backgroundColor = '#546E7A'; 
			msg.style.display = 'block';
			setTimeout(() => { msg.style.display = 'none'; }, 3000);
		}
		


        async function fetchFromGoogleSheet(isQuickFetch = false) {
            const url = document.getElementById('googleSheetUrl').value;
            const statusEl = document.getElementById('fetch-status');
            const analyzeButton = document.getElementById('analyzeButton');
            const dataTextArea = document.getElementById('dataToAnalyze');

            if (!url || !url.startsWith('https://script.google.com/macros/s/')) {
                statusEl.textContent = 'âŒ ×× × ×”×–×Ÿ ×›×ª×•×‘×ª URL ×ª×§×™× ×” ×©×œ Web App.';
                statusEl.style.color = 'red';
                statusEl.style.display = 'block';
                return;
            }

            localStorage.setItem('googleSheetUrl', url);

            statusEl.textContent = '×˜×•×¢×Ÿ × ×ª×•× ×™× ××”-Sheet... ğŸ”„';
            statusEl.style.color = 'var(--primary-blue)';
            statusEl.style.display = 'block';
            document.getElementById('fetchFromSheetButton').disabled = true;

            try {
                const fetchUrl = `${url}?action=getData&t=${Date.now()}`;
                const response = await fetch(fetchUrl);
                
                if (!response.ok) throw new Error(`×©×’×™××ª ×¨×©×ª (${response.status})`);
                
                const data = await response.text();

                dataTextArea.value = data;Â 
                statusEl.textContent = 'âœ… × ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×”! ×× ×ª×—...';
                statusEl.style.color = 'green';
                
                analyzeButton.click();Â 

                setTimeout(() => { statusEl.style.display = 'none'; }, 5000);

            } catch (error) {
                statusEl.textContent = `âŒ ×©×’×™××”: ${error.message}. ×‘×“×•×§ ××ª ×”-URL ×•×”×¨×©××•×ª ×”-Web App (×¦×¨×™×š ×œ×”×™×•×ª 'Execute as: Me' ×•-'Who has access: Anyone').`;
                statusEl.style.color = 'red';
            } finally {
                document.getElementById('fetchFromSheetButton').disabled = false;
            }
        }
		
		// --- ×¤×•× ×§×¦×™×•×ª × ×™×”×•×œ ×›×¤×ª×•×¨×™ ×©×•××¨×™× (×”×•×¡×¤×” ×—×“×©×”) ---
        function generateGuardsButtons() {
            const container = document.getElementById('guardButtonsContainer');
            if (!container) return;
            container.innerHTML = ''; 
            Object.keys(colorMap).forEach(name => {
                const btn = document.createElement('button');
                btn.textContent = name;
                btn.className = 'guard-btn';
                btn.type = 'button';
                btn.onclick = function() {
                    this.classList.toggle('active');
                    updateGuardsTextarea();
                };
                container.appendChild(btn);
            });
        }

        function updateGuardsTextarea() {
            const activeButtons = document.querySelectorAll('.guard-btn.active');
            const selectedNames = Array.from(activeButtons).map(btn => btn.textContent);
            document.getElementById('guardsFor5Shifts').value = selectedNames.join(', ');
        }

        // --- ×§×™×©×•×¨ ××™×¨×•×¢×™× ×œ×›×¤×ª×•×¨×™× ---
        
        document.getElementById('analyzeButton').addEventListener('click', () => {
            const textContent = document.getElementById('dataToAnalyze').value;
            renderSchedule(parseVerticalText(textContent));
        });
		
		document.getElementById('downloadButton').addEventListener('click', downloadCsvFile);

        document.getElementById('resetButton').addEventListener('click', () => {
             document.getElementById('dataToAnalyze').value = '';
             document.getElementById('results-container').innerHTML = `<p id="initial-message">×”×˜×¢×™× ×” ×”×¨××©×•× ×™×ª ×ª×¤×¢×™×œ ××ª ×”× ×™×ª×•×— ××•×˜×•××˜×™×ª.</p>`;
             lastRenderedTableHTML = '';
             initializeData(); 
        });
        
        document.getElementById('generateLinkButton').addEventListener('click', downloadHtmlTable);
        document.getElementById('autoScheduleButton').addEventListener('click', autoSchedule);
        document.getElementById('fetchFromSheetButton').addEventListener('click', fetchFromGoogleSheet);
		document.getElementById('quickFetchButton').addEventListener('click', () => fetchFromGoogleSheet(true));
		
		// ×”×‘×œ×˜×ª ×›×œ ×”×©××•×ª ×”×–×”×™× ×‘×˜×‘×œ×” ×‘×¢×ª ××¢×‘×¨ ×¢×›×‘×¨
        document.addEventListener('mouseover', function (e) {
            if (e.target.classList.contains('person')) {
                const name = e.target.textContent.trim();
                document.querySelectorAll('.person').forEach(el => {
                    if (el.textContent.trim() === name) el.classList.add('highlight-name');
                });
            }
        });

        document.addEventListener('mouseout', function (e) {
            if (e.target.classList.contains('person')) {
                document.querySelectorAll('.person').forEach(el => el.classList.remove('highlight-name'));
            }
        });
		
    

		// ×¡×’×™×¨×ª ×”-mouseout ×”×§×•×“×

        // --- × ×™×”×•×œ ×”×‘×œ×˜×ª ×©××•×ª ×¡×•×¤×™ ×•××•×’×Ÿ ××”×‘×”×•×‘ (××—×©×‘ + × ×™×™×“) ---
        let lockedName = null; 
        let lastTouchTime = 0; 

        function updateHighlights(nameToHighlight) {
            const allPersons = document.querySelectorAll('.person');
            allPersons.forEach(el => {
                if (nameToHighlight && el.textContent.trim() === nameToHighlight) {
                    el.classList.add('highlight-name');
                } else {
                    el.classList.remove('highlight-name');
                }
            });
        }

        document.addEventListener('touchstart', function() {
            lastTouchTime = Date.now();
        }, { passive: true });

        document.addEventListener('mouseover', function (e) {
            if (Date.now() - lastTouchTime < 500) return;
            const personEl = e.target.closest('.person');
            if (personEl && !lockedName) {
                updateHighlights(personEl.textContent.trim());
            }
        });

        document.addEventListener('mouseout', function (e) {
            if (Date.now() - lastTouchTime < 500) return;
            if (!lockedName) {
                updateHighlights(null);
            }
        });

        document.addEventListener('click', function (e) {
            const personEl = e.target.closest('.person');
            if (personEl) {
                const clickedName = personEl.textContent.trim();
                if (lockedName === clickedName) {
                    lockedName = null;
                    updateHighlights(null);
                } else {
                    lockedName = clickedName;
                    updateHighlights(clickedName);
                }
            } else {
                lockedName = null;
                updateHighlights(null);
            }
        });
    </script>
</body>
</html>
